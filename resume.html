<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Easy Resume ‚Äî Builder</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
:root{
  --accent:#8b5cf6; --accent2:#ec4899;
  --ink:#0e1117; --ink-weak:#475569;
  --paper:#ffffff; --panel:#0f1420; --panel-2:#121a2a;
  --bg:#0b0f19; --grid:#121826; --line:#23283b; --soft:#eef2f7;
  --rail:#f1f5f9; --shadow:0 10px 30px rgba(0,0,0,.25);
  --ring:0 0 0 3px color-mix(in srgb, var(--accent) 35%, #0000) inset;
  --pad:14px;
  --radius:16px;
  --star-size:16px;
  --stars-width:116px; /* <- slider bar matches this width */
}

/* themes */
[data-theme="coral"]{ --accent:#ff7b54; --accent2:#ffd166 }
[data-theme="sea"]{ --accent:#4facfe; --accent2:#38d2ff }
[data-theme="city"]{ --accent:#34d399; --accent2:#9ca3af }
[data-theme="magentaPurple"]{ --accent:#c026d3; --accent2:#9333ea }
[data-theme="magentaPink"]{ --accent:#ec4899; --accent2:#f97316 }
[data-theme="blueGreen"]{ --accent:#22c1c3; --accent2:#2ecc71 }
[data-theme="mono"]{ --accent:#111827; --accent2:#6b7280 }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  color:#e6e8ef;
  background:var(--bg);
  display:grid; grid-template-rows:auto 1fr;
}

/* dark mode toggle affects page colors */
body:not([data-dark="1"]) { --paper:#fff; --ink:#0f172a; --ink-weak:#64748b; }
body[data-dark="1"] { --paper:#0d1524; --ink:#e6e8ef; --ink-weak:#aab3c5; --rail:#0f1b31; --soft:#0e1a32; }

/* top nav */
.nav{position:sticky;top:0;z-index:10000;display:flex;justify-content:center;gap:10px;align-items:center;padding:10px 14px;background:linear-gradient(180deg,#0b0f19,rgba(11,15,25,.85));border-bottom:1px solid #1d2336;backdrop-filter:blur(8px)}
.brand{font-weight:800}
.menu{display:flex;gap:10px;align-items:center;padding:6px 10px;border-radius:14px;background:#0f1420;border:1px solid #1f2540;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.mbtn{appearance:none;border:1px solid #2b324b;background:#12182a;color:#e6e8ef;padding:7px 10px;border-radius:12px;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.3)}
.mbtn:hover{box-shadow:0 0 0 3px rgba(99,102,241,.3) inset, 0 8px 24px rgba(0,0,0,.35)}
.dropdown{position:relative}
.dropdown-menu{position:absolute;top:120%;left:0;background:#0f1420;border:1px solid var(--line);border-radius:12px;min-width:260px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:none;padding:10px;z-index:9999}
.dropdown.open .dropdown-menu{display:block}
.dropdown-menu button{display:block;width:100%;text-align:left;background:transparent;color:#e6e8ef;border:0;padding:8px 10px;border-radius:10px;cursor:pointer}
.dropdown-menu button:hover{background:#172038}

/* canvas */
#canvas{display:flex;justify-content:center;overflow:auto;padding:18px}
#canvas.blurred{filter:blur(4px);transform:scale(.99)}
.page{background:var(--paper);color:var(--ink);width:860px;min-height:1200px;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35);position:relative}
.page::before{content:"";position:absolute;inset:16px;pointer-events:none;background:
  linear-gradient(90deg,transparent 15px,#eef2f7 16px),
  linear-gradient(transparent 15px,#eef2f7 16px);background-size:16px 16px;opacity:.15;border-radius:14px}
#sheet{padding:24px;min-height:1120px}
.stack{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px;align-content:start}
.placeholder{grid-column:1/-1;display:grid;place-items:center;color:#8c95b1}
.placeholder svg{width:48px;height:48px;margin:0 auto 8px}

/* nodes / section shells */
.node{position:relative;background:#f8f9fb;border:1px solid #e9eef8;border-radius:16px;padding:10px 12px;box-shadow:0 1px 3px rgba(0,0,0,.08);grid-column:span 12;transition:transform .18s ease, box-shadow .18s ease}
.node.sel{outline:2px solid #7c99ff; box-shadow:0 12px 30px rgba(124,153,255,.25)}
.node[data-locked="1"]{background:transparent;border:0;box-shadow:none;padding:0}

/* controls ‚Äî bubbly */
.ui{position:absolute;right:10px;top:10px;display:flex;gap:8px}
.uib{width:30px;height:30px;border-radius:999px;background:#0f1420;border:1px solid #27304d;color:#fff;display:grid;place-items:center;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.uib:hover{box-shadow:0 0 0 3px rgba(124,153,255,.3) inset, 0 14px 28px rgba(0,0,0,.4)}
.uib.handle{cursor:grab}
.preview .ui,.preview .add-dot,.preview .fmtbar,.preview .rail .rail-actions,.preview .chip .rm,.preview .ctrl-mini,.preview .move-where{display:none!important}

/* add anchor */
.add-squircle{grid-column:1/-1;display:grid;place-items:center;padding:28px 0}
.add-dot{width:80px;height:80px;border-radius:22px;border:2px dashed #a3aed0;display:grid;place-items:center;color:#64748b;cursor:pointer;background:var(--paper);box-shadow:var(--shadow);font-size:28px;font-weight:900}
.add-dot:hover{border-color:#7c99ff;color:#7c99ff}

/* skills block */
.title-center{display:grid;place-items:center;margin-bottom:8px}
.title-center .bar{width:160px;height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.tip{color:var(--ink-weak);font-size:12px;line-height:1.3;margin:8px 0 12px}
.preview .tip{display:none}

.grid-skills{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-skills.cols-1{grid-template-columns:1fr}
.sidebar .grid-skills{grid-template-columns:1fr!important}

.skill-row{display:grid;grid-template-columns:auto 1fr var(--stars-width);align-items:center;gap:10px}
.skill-row .lbl{min-width:0;max-width:260px}
.skill-row .lbl[contenteditable]{padding:2px 6px;border-radius:8px;border:1px solid transparent}
.skill-row .lbl[contenteditable]:focus{outline:0;border-color:#cbd5e1;background:#f1f5f9}
.skill-row .stars{display:grid;grid-auto-flow:column;grid-auto-columns:calc(var(--star-size) + 2px);gap:6px;justify-content:end}
.star{width:var(--star-size);height:var(--star-size);fill:#d1d5db;cursor:pointer;transition:transform .08s ease}
.star.active{fill:#f59e0b}
.star:active{transform:scale(.92)}

.skill-row input[type=range]{-webkit-appearance:none;appearance:none;width:var(--stars-width);height:4px;border-radius:999px;background:linear-gradient(90deg,var(--accent2),var(--accent))}
.skill-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--paper);border:2px solid var(--accent);box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer}

/* section headings */
.section{background:var(--soft);border:1px solid #e9eef8;border-radius:16px;padding:12px}
.section-title{display:grid;place-items:center;gap:6px;margin:4px 0 10px}
.section-title h2{margin:0;font-size:20px}
.section-title .bar{width:160px;height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2))}

/* Education cards */
.edu-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.edu-card{
  background:color-mix(in srgb, var(--accent) 10%, var(--paper));
  border:1px solid color-mix(in srgb, var(--accent) 22%, #0000);
  border-radius:14px;padding:12px 14px;display:grid;gap:8px;position:relative
}
.edu-line{display:flex;align-items:center;gap:8px;font-weight:700}
.edu-chip{display:inline-block;background:color-mix(in srgb, var(--accent) 18%, var(--paper));color:color-mix(in srgb, var(--accent) 70%, #000);border:1px solid color-mix(in srgb, var(--accent) 35%, #0000);padding:2px 10px;border-radius:999px;font-size:12px}
.edu-acad{min-height:2lh}

/* Experience */
.exp-list{display:grid;gap:12px}
.exp-card{
  background:color-mix(in srgb, var(--accent) 12%, var(--paper));
  border:1px solid color-mix(in srgb, var(--accent) 22%, #0000);
  border-radius:14px;padding:12px 14px;position:relative;display:grid;gap:6px
}
.exp-head{display:flex;align-items:center;gap:10px}
.badge{display:inline-block;background:color-mix(in srgb, var(--accent) 18%, var(--paper));color:color-mix(in srgb, var(--accent) 70%, #000);border:1px solid color-mix(in srgb, var(--accent) 35%, #0000);padding:2px 10px;border-radius:999px;font-weight:700;font-size:12px}
.exp-card+.exp-card{margin-top:8px}

/* Sidebar layout */
.sidebar-layout{display:grid;grid-template-columns:280px minmax(0,1fr);gap:16px}
.rail{background:linear-gradient(135deg,var(--accent2),var(--accent));border-radius:14px;padding:18px 14px;display:flex;flex-direction:column;gap:12px}
.rail .name{font-weight:900;font-size:26px;text-align:center;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.rail .chip{background:#fff;border:1px solid rgba(0,0,0,.08);padding:6px 10px;border-radius:999px;display:flex;gap:8px;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.rail .chip .rm{margin-left:auto;background:#111827;color:#fff;border-radius:8px;border:0;padding:2px 6px;cursor:pointer}
.sidebar .section{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.25)}
.sidebar .section .section-title h2{color:#fff}

/* avatar */
.avatar{border-radius:999px;overflow:hidden;background:#d1d5db;position:relative;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.18);border:5px solid #fff;width:140px;height:140px;margin:0 auto}
.avatar input{display:none}
.avatar canvas{width:100%;height:100%;display:block}
.avatar[data-empty="1"]::after{content:'+';position:absolute;inset:0;display:grid;place-items:center;color:#111;font-weight:900;font-size:30px;background:rgba(255,255,255,.6);border-radius:999px}

/* wizard */
#welcome{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:20000;opacity:1;transition:opacity .35s ease}
#welcome.hide{opacity:0;pointer-events:none}
.wcard{width:min(880px,94vw);background:#0f1420;border:1px solid #1f2540;border-radius:18px;padding:22px;color:#e6e8ef;box-shadow:0 40px 140px rgba(0,0,0,.6)}
.wtitle{font-size:22px;font-weight:800;margin:0 0 8px}
.wsub{opacity:.8;margin-bottom:12px}
.center{display:flex;justify-content:center;gap:12px;align-items:center}
.wbtn{appearance:none;border:1px solid #2b324b;background:#12182a;color:#e6e8ef;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 10px 24px rgba(0,0,0,.35)}
.wbtn:hover{box-shadow:0 0 0 3px rgba(124,153,255,.3) inset, 0 14px 28px rgba(0,0,0,.4)}
.wbtn.primary{background:linear-gradient(135deg,var(--accent2),var(--accent));color:#111;border:none}

#wizard{display:none}
#wizard.show{display:flex}
.wiz{width:min(1020px,96vw);max-height:min(84vh,760px);background:#0f1420;border:1px solid #1f2540;border-radius:18px;padding:10px;box-shadow:0 40px 140px rgba(0,0,0,.6);display:grid;grid-template-columns:260px 1fr;gap:10px}
.wiz-left{border-right:1px solid #1f2540;padding:8px 6px 8px 10px;overflow:auto}
.step-li{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;margin:4px 0}
.step-li .dot{width:10px;height:22px;border-radius:999px;background:#2a3559}
.step-li.active .dot{background:linear-gradient(180deg,var(--accent2),var(--accent))}
.step-li.done::after{content:"\f00c";font-family:"Font Awesome 6 Free";font-weight:900;margin-left:auto;color:#34d399}
.wiz-right{padding:8px 10px;overflow:auto}
.wiz-actions{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:16px}
.wiz-actions .left{margin-right:auto}
.inp{width:70%;padding:10px 12px;border-radius:12px;border:1px solid #2b324b;background:#0b1222;color:#e6e8ef}
.swatch{width:120px;height:44px;border-radius:14px;border:1px solid #2b324b;margin:6px;display:inline-block;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.25)}
.swatch:hover{box-shadow:0 0 0 3px rgba(124,153,255,.25) inset, 0 12px 26px rgba(0,0,0,.35)}
.toggle{width:56px;height:28px;border-radius:999px;background:#1f2a45;border:1px solid #2f3b62;display:inline-flex;align-items:center;padding:2px;cursor:pointer}
.toggle .knob{width:24px;height:24px;border-radius:999px;background:#cbd5e1;transform:translateX(0);transition:transform .18s ease}
.toggle.on .knob{transform:translateX(28px);background:var(--accent)}

/* layout mockups */
.mock{width:220px;height:150px;background:#0b1222;border:1px solid #27304d;border-radius:16px;padding:12px;display:inline-block;margin:6px;cursor:pointer;position:relative;box-shadow:0 8px 18px rgba(0,0,0,.25)}
.mock:hover{box-shadow:0 0 0 3px rgba(124,153,255,.25) inset, 0 12px 26px rgba(0,0,0,.35)}
.mock.sel{outline:2px solid #ffb86c}
.mk-rail{position:absolute;left:12px;top:12px;bottom:12px;width:28%;border-radius:12px;background:linear-gradient(135deg,#5b6fb7,#2f3d7a)}
.mk-rail .mk-av{width:42px;height:42px;border-radius:999px;background:#cfd6ff;border:3px solid #fff;margin:8px auto}
.mk-lines{position:absolute;right:12px;left:calc(12px + 32%);top:22px;display:grid;gap:8px}
.mk-line{height:10px;border-radius:999px;background:#2b375f}
.mk-hero{position:absolute;left:12px;right:12px;top:12px;height:52px;border-radius:14px;background:linear-gradient(135deg,#5b6fb7,#2f3d7a)}
.mk-hero .mk-av{position:absolute;left:50%;top:38px;transform:translateX(-50%);width:48px;height:48px;border-radius:999px;background:#cfd6ff;border:3px solid #fff}
.mk-hero-right .mk-av{position:absolute;right:18px;top:26px;width:52px;height:52px;border-radius:999px;background:#cfd6ff;border:3px solid #fff}

/* formatting bar (kept simple) */
.fmtbar{position:absolute;display:none;gap:6px;background:#0f1420;border:1px solid #1f2540;padding:6px 8px;border-radius:10px;z-index:12000}
.fmtbar button{background:#12182a;border:1px solid #2b324b;color:#e6e8ef;border-radius:8px;padding:4px 6px;cursor:pointer}

/* preview */
.preview .ui,.preview .mbtn[data-role="add-skill"],.preview .move-where{display:none!important}
.preview .page::before{opacity:0}

/* print */
@media print{ .nav,#welcome,.fmtbar{display:none!important} #canvas{filter:none} .page{box-shadow:none} .page::before{opacity:0} }
</style>
</head>
<body data-theme="magentaPurple">
  <div class="nav">
    <span class="brand">Easy Resume</span>
    <div class="menu">
      <div class="dropdown" id="ddFile">
        <button class="mbtn">File ‚ñæ</button>
        <div class="dropdown-menu">
          <button id="saveJSON"><i class="fa-solid fa-floppy-disk"></i> Save project</button>
          <button id="loadJSON"><i class="fa-solid fa-folder-open"></i> Load project</button>
          <button id="startScratch"><i class="fa-solid fa-eraser"></i> Start from scratch</button>
        </div>
      </div>

      <div class="dropdown" id="ddLayout">
        <button class="mbtn">Layout options ‚ñæ</button>
        <div class="dropdown-menu" style="width:720px">
          <div id="layoutPickerMenu">
            <div class="mock sel" data-layout="header-side" title="Sidebar">
              <div class="mk-rail"><div class="mk-av"></div></div>
              <div class="mk-lines">
                <div class="mk-line" style="width:70%"></div>
                <div class="mk-line" style="width:56%"></div>
                <div class="mk-line" style="width:64%"></div>
              </div>
            </div>
            <div class="mock" data-layout="header-fancy" title="Top Fancy">
              <div class="mk-hero"><div class="mk-av"></div></div>
              <div class="mk-lines" style="left:18px;right:18px;top:82px">
                <div class="mk-line" style="width:66%"></div>
                <div class="mk-line" style="width:46%"></div>
                <div class="mk-line" style="width:54%"></div>
              </div>
            </div>
            <div class="mock" data-layout="header-top" title="Top Bar">
              <div class="mk-hero mk-hero-right"><div class="mk-av"></div></div>
              <div class="mk-lines" style="left:18px;right:18px;top:82px">
                <div class="mk-line" style="width:66%"></div>
                <div class="mk-line" style="width:46%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="dropdown" id="ddTheme">
        <button class="mbtn">Theme ‚ñæ</button>
        <div class="dropdown-menu">
          <div style="padding:8px 8px 6px;font-weight:700">Presets</div>
          <div id="themeSwatches" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 8px 8px">
            <div class="swatch" data-k="coral" style="background:linear-gradient(90deg,#ff7b54,#ffd166)"></div>
            <div class="swatch" data-k="sea" style="background:linear-gradient(90deg,#4facfe,#38d2ff)"></div>
            <div class="swatch" data-k="city" style="background:linear-gradient(90deg,#34d399,#9ca3af)"></div>
            <div class="swatch" data-k="magentaPurple" style="background:linear-gradient(90deg,#c026d3,#9333ea)"></div>
            <div class="swatch" data-k="magentaPink" style="background:linear-gradient(90deg,#ec4899,#f97316)"></div>
            <div class="swatch" data-k="blueGreen" style="background:linear-gradient(90deg,#22c1c3,#2ecc71)"></div>
            <div class="swatch" data-k="mono" style="background:linear-gradient(90deg,#0f172a,#6b7280)"></div>
          </div>
          <div style="border-top:1px solid #23283b;margin:8px 0"></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px">
            <span style="opacity:.8">Dark mode</span>
            <div id="darkToggle" class="toggle"><div class="knob"></div></div>
          </div>
          <div style="border-top:1px solid #23283b;margin:8px 0"></div>
          <div style="padding:8px 8px 14px;display:grid;gap:8px">
            <div style="font-weight:700">Custom gradient</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="color" id="c1" value="#8b5cf6" style="width:42px;height:28px;border:0;border-radius:6px">
              <input type="color" id="c2" value="#ec4899" style="width:42px;height:28px;border:0;border-radius:6px">
              <button id="applyCustom" class="mbtn">Apply</button>
            </div>
          </div>
        </div>
      </div>

      <button id="pdfBtn" class="mbtn"><i class="fa-solid fa-download"></i> Download</button>
      <button id="togglePreview" class="mbtn">Preview</button>
    </div>
  </div>

  <div id="canvas" class="blurred">
    <div class="page" id="page">
      <div id="sheet">
        <div class="stack" id="stack">
          <div class="placeholder" id="ph">
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
              Drag an item to begin building your resume
            </div>
          </div>
          <div class="add-squircle" id="canvasAdd"><div class="add-dot" id="dotAdd">+</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add menu -->
  <div class="pop" id="addMenu" style="position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:#0f1420;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:10px;display:none;z-index:9999">
    <div class="tray" style="display:flex;gap:10px;align-items:center">
      <button class="mbtn" data-add="section-skills" style="width:44px;height:44px;border-radius:12px;display:grid;place-items:center"><i class="fa-solid fa-layer-group"></i></button>
      <button class="mbtn" data-add="section-edu" style="width:44px;height:44px;border-radius:12px;display:grid;place-items:center"><i class="fa-solid fa-user-graduate"></i></button>
      <button class="mbtn" data-add="section-exp" style="width:44px;height:44px;border-radius:12px;display:grid;place-items:center"><i class="fa-solid fa-briefcase"></i></button>
    </div>
  </div>

  <!-- Welcome (intro only) -->
  <div id="welcome">
    <div class="wcard" id="welcomeCard">
      <div class="wtitle">Welcome to the Easy Resume Builder</div>
      <div class="wsub">Choose how to begin.</div>
      <div class="center" style="flex-direction:column;gap:10px">
        <div class="center" style="gap:12px;flex-wrap:wrap">
          <button class="wbtn primary" id="startWizard">Wizard</button>
          <button class="wbtn" id="startBlank">Manual mode</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px;opacity:.85">
          <div style="text-align:center">Guided step-by-step set-up.</div>
          <div style="text-align:center">Start from scratch, arrange freely.</div>
        </div>
      </div>
    </div>

    <!-- Wizard modal -->
    <div class="wiz" id="wizard" role="dialog" aria-modal="true" aria-label="Resume wizard">
      <div class="wiz-left" id="wizList"></div>
      <div class="wiz-right">
        <div id="wizBody"></div>
        <div class="wiz-actions">
          <div class="left"><button id="wizReset" class="mbtn" style="display:none">Start over</button></div>
          <button id="wizBack" class="mbtn" style="display:none">Back</button>
          <button id="wizNext" class="mbtn primary">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- formatting bar -->
  <div class="fmtbar" id="fmtbar">
    <button data-cmd="bold"><b>B</b></button>
    <button data-cmd="italic"><i>I</i></button>
    <button data-cmd="underline"><u>U</u></button>
    <button data-insert="‚Ä¢ ">‚Ä¢</button>
    <button data-insert="‚úì ">‚úì</button>
    <button data-insert="üèÜ ">üèÜ</button>
  </div>

<script>
(function(){
'use strict';

/* tiny helpers */
const $=(s,r)=> (r||document).querySelector(s);
const $$=(s,r)=> Array.from((r||document).querySelectorAll(s));

/* state */
const STATE={
  layout:'header-side',
  theme:'magentaPurple',
  dark:false,
  name:'',
  chips:{phone:'',email:'',address:'',linkedin:''},
  skills:[],         // {type:'stars'|'slider', label, value(0..5 or 0..100)}
  skillsWhere:'sidebar', // 'sidebar' or 'canvas'
  edu:[],            // {title:'', year:'', academy:''}
  exp:[]             // {when:'', role:'', org:'', desc:''}
};

const canvas=$('#canvas'), stack=$('#stack'), addAnchor=$('#canvasAdd'), ph=$('#ph');
function updatePH(){ ph.style.display = stack.querySelector('.node:not([data-locked="1"])') ? 'none':'grid'; }
function moveAddAnchor(){
  // keep centered under last content
  const last=[...stack.children].reverse().find(n=>n.classList&&n.classList.contains('node'));
  if(last && addAnchor.parentElement!==stack) stack.appendChild(addAnchor);
  addAnchor.style.gridColumn='1/-1';
}

/* HEADER BUILDERS (minimal, solid) */
function headerTopBar(){
  const n=document.createElement('div'); n.className='node'; n.setAttribute('data-locked','1');
  n.innerHTML=`
  <div class="section" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#111;border:0">
    <div style="display:grid;grid-template-columns:1fr 160px;gap:18px;align-items:center">
      <h1 class="name" contenteditable style="margin:0;text-align:center;color:#111;text-shadow:0 1px 0 #fff">YOUR NAME</h1>
      <div class="avatar" data-avatar data-empty="1"><canvas width="140" height="140"></canvas><input type="file" accept="image/*"></div>
    </div>
  </div>`;
  return n;
}
function headerFancy(){
  const n=document.createElement('div'); n.className='node'; n.setAttribute('data-locked','1');
  n.innerHTML=`
  <div class="section" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#111;border:0">
    <div class="title-center"><h2 style="color:#111">YOUR NAME</h2><div class="bar"></div></div>
    <div class="avatar" data-avatar data-empty="1" style="margin-top:-40px"><canvas width="140" height="140"></canvas><input type="file" accept="image/*"></div>
  </div>`;
  return n;
}
function headerSidebar(){
  const n=document.createElement('div'); n.className='node'; n.setAttribute('data-locked','1');
  n.innerHTML=`
  <div class="sidebar-layout">
    <div class="rail sidebar">
      <div class="avatar" data-avatar data-empty="1"><canvas width="140" height="140"></canvas><input type="file" accept="image/*"></div>
      <div class="name" contenteditable>YOUR NAME</div>
      <div id="railChips"></div>
      <div class="section" id="railSkills" style="display:none">
        <div class="section-title"><h2>Skills</h2><div class="bar"></div></div>
        <div class="tip">Tip: Use ‚òÖ or the slider to rate your confidence. You can add languages, tools or any ability here.</div>
        <div class="grid-skills cols-1"></div>
      </div>
    </div>
    <div data-zone="main" id="mainZone"></div>
  </div>`;
  return n;
}
function isSidebar(){ return !!stack.querySelector('.sidebar-layout'); }
function mainZone(){ return $('#mainZone',stack) || stack; }

/* AVATAR (light) */
function initAvatar(w){
  const input=w.querySelector('input'), cv=w.querySelector('canvas');
  const ctx=cv.getContext('2d',{willReadFrequently:true});
  let img=null, s=1, minS=1, x=0, y=0, drag=0, sx=0, sy=0;
  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height); ctx.save();
    ctx.beginPath(); ctx.arc(cv.width/2,cv.height/2,cv.width/2,0,Math.PI*2); ctx.clip();
    if(img){ ctx.imageSmoothingQuality='high'; ctx.drawImage(img,x,y,img.width*s,img.height*s); w.setAttribute('data-empty','0'); }
    ctx.restore();
  }
  if(input) input.addEventListener('change',e=>{
    const f=input.files&&input.files[0]; if(!f) return;
    const i=new Image(); i.onload=()=>{ img=i; minS=Math.max(cv.width/i.width,cv.height/i.height); s=minS; x=(cv.width-i.width*s)/2; y=(cv.height-i.height*s)/2; draw(); };
    i.src=URL.createObjectURL(f); setTimeout(()=>URL.revokeObjectURL(i.src),6000);
  });
  cv.addEventListener('mousedown',e=>{ drag=1; sx=e.clientX; sy=e.clientY; });
  window.addEventListener('mouseup',()=>drag=0);
  window.addEventListener('mousemove',e=>{ if(!drag) return; x+=e.clientX-sx; y+=e.clientY-sy; sx=e.clientX; sy=e.clientY; draw(); });
  cv.addEventListener('wheel',e=>{ e.preventDefault(); if(!img) return; const d=e.deltaY<0?1.06:0.94; let ns=s*d; if(ns<minS) ns=minS; if(ns>5) ns=5; const r=cv.getBoundingClientRect(); const mx=e.clientX-r.left, my=e.clientY-r.top; const dx=(mx-x)/s, dy=(my-y)/s; x=mx-dx*ns; y=my-dy*ns; s=ns; draw(); },{passive:false});
}

/* SKILLS helpers */
function starSvg(i){ return `<svg class="star" data-i="${i}" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>`;}
function makeSkillRow(type='stars',label='Skill',val= type==='stars'?0:50){
  const row=document.createElement('div'); row.className='skill-row'; row.setAttribute('draggable','true');
  row.innerHTML=`
    <button class="uib handle" title="Drag"><i class="fa-solid fa-grip-vertical"></i></button>
    <div class="lbl" contenteditable>${label||'Skill'}</div>
    <div class="where">
      ${type==='stars' ? `<div class="stars">${[1,2,3,4,5].map(starSvg).join('')}</div>` :
        `<input type="range" min="0" max="100" value="${val}">`}
    </div>`;
  if(type==='stars') $$('.star',row).forEach((s,idx)=>{ s.addEventListener('click',()=>{ const n=idx+1; $$('.star',row).forEach((x,i)=>x.classList.toggle('active',i<n)); }); });
  return row;
}

/* Sections */
function skillsSection(sidebar=false){
  const node=document.createElement('div'); node.className='node';
  node.innerHTML=`
  <div class="ui">
    <button class="uib handle" title="Drag section"><i class="fa-solid fa-grip-vertical"></i></button>
    <button class="uib move-where" title="Move ${sidebar?'to canvas':'to sidebar'}"><i class="fa-solid fa-up-down-left-right"></i></button>
    <button class="uib del" title="Delete"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="section ${sidebar?'sidebar':''}">
    <div class="section-title"><h2>Skills</h2><div class="bar"></div></div>
    <div class="tip">Tip: Use ‚òÖ or the slider to rate your confidence. You can add languages, tools or any ability here.</div>
    <div class="grid-skills ${sidebar?'cols-1':'cols-2'}"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button class="mbtn" data-add-star title="Add stars"><i class="fa-solid fa-plus"></i> ‚òÖ</button>
      <button class="mbtn" data-add-slider title="Add slider"><i class="fa-solid fa-plus"></i> <i class="fa-solid fa-sliders"></i></button>
    </div>
  </div>`;
  // events
  $('.del',node).onclick=()=>{ node.remove(); updatePH(); };
  $('.move-where',node).onclick=()=>{
    STATE.skillsWhere = sidebar? 'canvas' : 'sidebar';
    applyStateToCanvas();
  };
  attachSectionDnd(node);
  return node;
}
function educationSection(){
  const node=document.createElement('div'); node.className='node';
  node.innerHTML=`
  <div class="ui">
    <button class="uib handle" title="Drag section"><i class="fa-solid fa-grip-vertical"></i></button>
    <button class="uib del" title="Delete"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="section">
    <div class="section-title"><h2>Education</h2><div class="bar"></div></div>
    <div class="edu-grid"></div>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:10px">
      <button class="mbtn" data-add="course"><i class="fa-solid fa-plus"></i> Add course</button>
      <button class="mbtn" data-add="degree"><i class="fa-solid fa-plus"></i> Add degree</button>
    </div>
  </div>`;
  $('.del',node).onclick=()=>node.remove();
  attachSectionDnd(node);
  return node;
}
function eduCard(kind='course',title='Title',year='2018‚Äì2022',acad='Academy name (wraps to two lines if needed)'){
  const card=document.createElement('div'); card.className='edu-card'; card.setAttribute('draggable','true');
  const icon = kind==='degree' ? 'fa-graduation-cap' : 'fa-scroll';
  const color = kind==='degree' ? 'var(--accent)' : 'var(--accent2)';
  card.innerHTML=`
    <div class="ui" style="top:6px;right:6px">
      <button class="uib handle" title="Drag"><i class="fa-solid fa-grip-vertical"></i></button>
      <button class="uib del" title="Delete"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="edu-line"><i class="fa-solid ${icon}" style="color:${color}"></i><div class="editable" contenteditable>${title}</div></div>
    <div class="edu-chip" contenteditable data-limit="9">${year}</div>
    <div class="edu-acad editable" contenteditable>${acad}</div>`;
  $('.del',card).onclick=()=>card.remove();
  return card;
}

function experienceSection(){
  const node=document.createElement('div'); node.className='node';
  node.innerHTML=`
  <div class="ui">
    <button class="uib handle" title="Drag section"><i class="fa-solid fa-grip-vertical"></i></button>
    <button class="uib del" title="Delete"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="section">
    <div class="section-title"><h2>Work experience</h2><div class="bar"></div></div>
    <div class="exp-list"></div>
    <div style="display:flex;justify-content:center;margin-top:10px">
      <button class="mbtn" data-add-role><i class="fa-solid fa-plus"></i> Add role</button>
    </div>
  </div>`;
  $('.del',node).onclick=()=>node.remove();
  attachSectionDnd(node);
  return node;
}
function expCard(dates='Jan 2022',role='Job title',org='@Company',desc='Describe impact, scale and results.'){
  const c=document.createElement('div'); c.className='exp-card'; c.setAttribute('draggable','true');
  c.innerHTML=`
    <div class="ui" style="top:6px;right:6px">
      <button class="uib handle" title="Drag"><i class="fa-solid fa-grip-vertical"></i></button>
      <button class="uib del" title="Delete"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="exp-head"><span class="badge" contenteditable data-limit="9">${dates}</span><div style="font-weight:800" contenteditable>${role}</div></div>
    <div style="font-weight:700;color:#374151" contenteditable>${org}</div>
    <div class="editable desc" contenteditable>${desc}</div>`;
  $('.del',c).onclick=()=>c.remove();
  return c;
}

/* DND ‚Äî sections only by handle */
function attachSectionDnd(node){
  node.addEventListener('dragstart',e=>{
    if(!e.target.closest('.handle')){ e.preventDefault(); return; }
    e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain','');
    node.style.opacity='.4';
  });
  node.addEventListener('dragend',()=> node.style.opacity='');
  stack.addEventListener('dragover',e=>{
    const dragging=$('.node[style*="opacity"]',stack); if(!dragging) return;
    e.preventDefault();
    const after=getAfter(e.clientY);
    if(after) stack.insertBefore(dragging, after); else stack.insertBefore(dragging, addAnchor);
  });
  function getAfter(y){
    const els=$$('.node',stack).filter(n=>n!==node && n!==addAnchor);
    let cand=null, off=-Infinity;
    els.forEach(ch=>{
      const r=ch.getBoundingClientRect(), o=y-r.top-r.height/2;
      if(o<0 && o>off){ off=o; cand=ch; }
    });
    return cand;
  }
}

/* Canvas add menu */
const dotAdd=$('#dotAdd'), addMenu=$('#addMenu');
dotAdd.onclick=()=>{
  filterAddMenu();
  addMenu.style.display='block';
  const rect=dotAdd.getBoundingClientRect();
  addMenu.style.left = (rect.left + rect.width/2)+'px';
};
document.addEventListener('click',e=>{
  if(addMenu.style.display==='block' && !addMenu.contains(e.target) && e.target!==dotAdd) addMenu.style.display='none';
});
$('#addMenu').addEventListener('click',e=>{
  const b=e.target.closest('button[data-add]'); if(!b) return;
  addMenu.style.display='none';
  const k=b.dataset.add;
  if(k==='section-skills'){ STATE.skillsWhere='canvas'; if(!STATE.skills.length) STATE.skills=[{type:'stars',label:'Skill',value:3}]; }
  if(k==='section-edu' && !STATE.edu.length){ STATE.edu=[{title:'Title',year:'2018‚Äì2022',acad:'Academy name (wraps to two lines if needed)',kind:'course'}]; }
  if(k==='section-exp' && !STATE.exp.length){ STATE.exp=[{when:'Jan 2022',role:'Job title',org:'@Company',desc:'Describe impact, scale and results.'}]; }
  applyStateToCanvas();
});
function filterAddMenu(){
  const hasSkills = !!stack.querySelector('.section h2') && $$('.section h2',stack).some(h=>h.textContent==='Skills');
  const hasEdu = $$('.section h2',stack).some(h=>h.textContent==='Education');
  const hasExp = $$('.section h2',stack).some(h=>h.textContent==='Work experience');
  $('[data-add="section-skills"]',addMenu).style.display = hasSkills ? 'none':'inline-flex';
  $('[data-add="section-edu"]',addMenu).style.display = hasEdu ? 'none':'inline-flex';
  $('[data-add="section-exp"]',addMenu).style.display = hasExp ? 'none':'inline-flex';
}

/* THEME + DARK */
$$('#themeSwatches .swatch').forEach(s=> s.addEventListener('click',()=>{ document.body.setAttribute('data-theme', s.dataset.k); STATE.theme=s.dataset.k; } ));
$('#applyCustom').onclick=()=>{ const a=$('#c1').value, b=$('#c2').value; document.body.style.setProperty('--accent', a); document.body.style.setProperty('--accent2', b); };
$('#darkToggle').onclick=()=>{ STATE.dark=!STATE.dark; document.body.setAttribute('data-dark', STATE.dark? '1':'0'); $('#darkToggle').classList.toggle('on',STATE.dark); };

/* FILES */
function getProject(){
  const data=JSON.stringify(STATE,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='resume_project.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),3000);
}
$('#saveJSON').onclick=getProject;
$('#loadJSON').onclick=()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.json';
  inp.onchange=()=>{ const f=inp.files&&inp.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ Object.assign(STATE, JSON.parse(String(r.result))); applyStateToCanvas(); }catch(_){ alert('Invalid JSON'); } };
    r.readAsText(f);
  };
  inp.click();
};
$('#startScratch').onclick=()=>{ Object.assign(STATE,{
  layout:'header-side', name:'', chips:{phone:'',email:'',address:'',linkedin:''},
  skills:[], skillsWhere:'sidebar', edu:[], exp:[]
}); applyStateToCanvas(); };

/* PRINT / PREVIEW */
$('#pdfBtn').onclick=()=>{ const was=document.body.classList.contains('preview'); document.body.classList.add('preview'); setTimeout(()=>{ window.print(); if(!was) setTimeout(()=>document.body.classList.remove('preview'),140); },60); };
$('#togglePreview').onclick=()=>{ const on=!document.body.classList.contains('preview'); document.body.classList.toggle('preview',on); $('#togglePreview').textContent=on?'Exit preview':'Preview'; };

/* WELCOME + WIZARD */
const welcome=$('#welcome'), welcomeCard=$('#welcomeCard'), wizard=$('#wizard');
$('#startBlank').onclick=()=>{ finishWelcome(); };
$('#startWizard').onclick=()=>{ welcomeCard.style.display='none'; wizard.classList.add('show'); renderWizard(); };

function finishWelcome(){ canvas.classList.remove('blurred'); welcome.classList.add('hide'); setTimeout(()=> welcome.remove(),420); }

/* Wizard steps */
const STEPS=[
  {k:'layout', label:'Layout', render:renderStepLayout, commit:commitLayout},
  {k:'theme', label:'Theme', render:renderStepTheme, commit:()=>{}},
  {k:'name', label:'Name', render:(b)=>renderAsk('What‚Äôs your name?','inpName','Your full name',STATE.name), commit:()=>{ STATE.name=$('#inpName').value.trim(); }},
  {k:'phone', label:'Phone', render:(b)=>renderAsk('What‚Äôs your phone number?','inpPhone','+34 600 123 456',STATE.chips.phone), commit:()=>{ STATE.chips.phone=$('#inpPhone').value.trim(); }},
  {k:'email', label:'Email', render:(b)=>renderAsk('Your email address?','inpEmail','you@example.com',STATE.chips.email), commit:()=>{ STATE.chips.email=$('#inpEmail').value.trim(); }},
  {k:'address', label:'Address', render:(b)=>renderAsk('What‚Äôs your address?','inpAddr','City, Country',STATE.chips.address), commit:()=>{ STATE.chips.address=$('#inpAddr').value.trim(); }},
  {k:'linkedin', label:'LinkedIn', render:renderLinked, commit:()=>{ const u=$('#inpLinked').value.trim(); STATE.chips.linkedin = u? `linkedin.com/in/${u}`:''; }},
  {k:'skills', label:'Skills', render:renderSkillsStep, commit:commitSkills},
  {k:'education', label:'Education', render:renderEduStep, commit:commitEdu},
  {k:'experience', label:'Experience', render:renderExpStep, commit:commitExp},
  {k:'done', label:'Done', render:renderDone, commit:()=>{}}
];
let stepIndex=0, backCount=0;

function renderWizard(){
  $('#wizList').innerHTML = STEPS.map((s,i)=>`
    <div class="step-li ${i===stepIndex?'active':''} ${i<stepIndex?'done':''}">
      <div class="dot"></div><div>${s.label}</div>
    </div>`).join('');
  const body=$('#wizBody'); body.innerHTML='';
  STEPS[stepIndex].render(body);
  // actions
  $('#wizBack').style.display = stepIndex>0 ? 'inline-flex':'none';
  $('#wizNext').textContent = stepIndex===STEPS.length-1? 'Close':'Next';
  $('#wizReset').style.display = backCount>=2 ? 'inline-flex':'none';
  $('#wizReset').onclick=()=>{ backCount=0; Object.assign(STATE,{name:'',chips:{phone:'',email:'',address:'',linkedin:''},skills:[],edu:[],exp:[]}); stepIndex=0; renderWizard(); };
  $('#wizBack').onclick=()=>{ backCount++; stepIndex=Math.max(0,stepIndex-1); renderWizard(); };
  $('#wizNext').onclick=()=>{
    if(stepIndex<STEPS.length){ STEPS[stepIndex].commit(); applyStateToCanvas(); }
    if(stepIndex===STEPS.length-1){ finishWelcome(); return; }
    backCount=0; stepIndex++; renderWizard();
  };
}

/* step UIs */
function renderStepLayout(body){
  body.innerHTML=`<div class="wtitle">Choose your layout</div>
    <div class="wsub">Pick a starting header style.</div>
    <div>
      <div class="mock ${STATE.layout==='header-side'?'sel':''}" data-layout="header-side">
        <div class="mk-rail"><div class="mk-av"></div></div>
        <div class="mk-lines"><div class="mk-line" style="width:70%"></div><div class="mk-line" style="width:56%"></div><div class="mk-line" style="width:64%"></div></div>
      </div>
      <div class="mock ${STATE.layout==='header-fancy'?'sel':''}" data-layout="header-fancy">
        <div class="mk-hero"><div class="mk-av"></div></div>
        <div class="mk-lines" style="left:18px;right:18px;top:82px"><div class="mk-line" style="width:66%"></div><div class="mk-line" style="width:46%"></div><div class="mk-line" style="width:54%"></div></div>
      </div>
      <div class="mock ${STATE.layout==='header-top'?'sel':''}" data-layout="header-top">
        <div class="mk-hero mk-hero-right"><div class="mk-av"></div></div>
        <div class="mk-lines" style="left:18px;right:18px;top:82px"><div class="mk-line" style="width:66%"></div><div class="mk-line" style="width:46%"></div></div>
      </div>
    </div>`;
  $$('.mock',body).forEach(m=> m.addEventListener('click',()=>{ $$('.mock',body).forEach(x=>x.classList.remove('sel')); m.classList.add('sel'); STATE.layout=m.dataset.layout; applyStateToCanvas(true); }));
}
function commitLayout(){ /* nothing extra */ }

function renderStepTheme(body){
  body.innerHTML=`<div class="wtitle">Choose a color theme</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:520px">
    ${['coral','sea','city','magentaPurple','magentaPink','blueGreen','mono'].map(k=>`<div class="swatch" data-k="${k}" style="background:linear-gradient(90deg,var(--accent2),var(--accent));" data-real="${k}"></div>`).join('')}
  </div>
  <div style="margin-top:12px;display:flex;align-items:center;gap:10px">
    <span>Dark mode</span> <div id="wizDark" class="toggle ${STATE.dark?'on':''}"><div class="knob"></div></div>
  </div>`;
  $$('.swatch',body).forEach(s=> s.onclick=()=>{ document.body.setAttribute('data-theme', s.dataset.real); STATE.theme=s.dataset.real; });
  $('#wizDark').onclick=()=>{ STATE.dark=!STATE.dark; document.body.setAttribute('data-dark', STATE.dark?'1':'0'); $('#wizDark').classList.toggle('on',STATE.dark); };
}

function renderAsk(title,id,ph,val){
  $('#wizBody').innerHTML=`<div class="wtitle">${title}</div>
  <div style="margin:10px 0"><input id="${id}" class="inp" placeholder="${ph}" value="${val||''}"></div>`;
  setTimeout(()=>$('#'+id).focus(),40);
}

function renderLinked(body){
  body.innerHTML=`<div class="wtitle">LinkedIn username</div>
  <div style="display:flex;gap:8px;align-items:center">
    <div style="opacity:.85">linkedin.com/in/</div>
    <input id="inpLinked" class="inp" style="width:340px" placeholder="your-handle" value="${(STATE.chips.linkedin||'').replace('linkedin.com/in/','')}">
  </div>`;
}

function renderSkillsStep(body){
  body.innerHTML=`<div class="wtitle">Add your skills</div>
  <div class="wsub">Use stars or a slider. This block can represent <b>languages</b>, <b>tools</b>, <b>abilities</b>‚Äî<b>anything</b>. The stars/slider reflect your confidence.</div>
  <div id="wizSkills" style="display:grid;gap:10px;max-width:660px;margin-top:8px"></div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="mbtn" id="wizAddStar"><i class="fa-solid fa-plus"></i> ‚òÖ</button>
    <button class="mbtn" id="wizAddSlider"><i class="fa-solid fa-plus"></i> <i class="fa-solid fa-sliders"></i></button>
  </div>
  <div style="margin-top:10px"><label><input type="checkbox" id="wizInSidebar" ${STATE.skillsWhere==='sidebar'?'checked':''}> Display skills in the sidebar</label></div>`;
  const wrap=$('#wizSkills');
  if(!STATE.skills.length){ STATE.skills=[{type:'stars',label:'Skill',value:3},{type:'slider',label:'Skill',value:60}]; }
  STATE.skills.forEach(s=> wrap.appendChild(makeSkillRow(s.type,s.label,s.value)));
  $('#wizAddStar').onclick=()=> wrap.appendChild(makeSkillRow('stars'));
  $('#wizAddSlider').onclick=()=> wrap.appendChild(makeSkillRow('slider'));
}
function commitSkills(){
  // read from step UI (if present)
  const wrap=$('#wizSkills'); if(!wrap) return;
  STATE.skills=[...wrap.children].map(r=>{
    const lbl=$('.lbl',r).textContent.trim()||'Skill';
    if($('.stars',r)) return {type:'stars',label:lbl,value:$$('.star.active',r).length};
    return {type:'slider',label:lbl,value:parseInt($('input[type=range]',r).value,10)};
  });
  STATE.skillsWhere = $('#wizInSidebar')?.checked ? 'sidebar':'canvas';
}

function renderEduStep(body){
  body.innerHTML=`<div class="wtitle">Education</div>
  <div class="wsub">Add courses and/or degrees.</div>
  <div class="edu-grid" id="wizEdu" style="max-width:720px"></div>
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="mbtn" id="wizAddCourse"><i class="fa-solid fa-plus"></i> Add course</button>
    <button class="mbtn" id="wizAddDegree"><i class="fa-solid fa-plus"></i> Add degree</button>
  </div>`;
  const g=$('#wizEdu');
  if(!STATE.edu.length){ STATE.edu=[{kind:'course',title:'Title',year:'2018‚Äì2022',acad:'Academy name (wraps to two lines if needed)'}]; }
  STATE.edu.forEach(e=> g.appendChild(eduCard(e.kind,e.title,e.year,e.acad)));
  $('#wizAddCourse').onclick=()=> g.appendChild(eduCard('course'));
  $('#wizAddDegree').onclick=()=> g.appendChild(eduCard('degree'));
}
function commitEdu(){
  const g=$('#wizEdu'); if(!g) return;
  STATE.edu=[...g.children].map(c=>{
    return {
      kind: $('.fa-graduation-cap',c)?'degree':'course',
      title: $('.editable',c).textContent.trim()||'Title',
      year: $('.edu-chip',c).textContent.trim().slice(0,9),
      acad: $('.edu-acad',c).textContent.trim()
    };
  });
}

function renderExpStep(body){
  body.innerHTML=`<div class="wtitle">Experience</div>
  <div class="exp-list" id="wizExp" style="max-width:760px"></div>
  <div style="display:flex;justify-content:center;margin-top:10px">
    <button class="mbtn" id="wizAddRole"><i class="fa-solid fa-plus"></i> Add role</button>
  </div>`;
  const g=$('#wizExp');
  if(!STATE.exp.length){ STATE.exp=[{when:'Jan 2022',role:'Job title',org:'@Company',desc:'Describe impact, scale and results.'}]; }
  STATE.exp.forEach(e=> g.appendChild(expCard(e.when,e.role,e.org,e.desc)));
  $('#wizAddRole').onclick=()=> g.appendChild(expCard());
}
function commitExp(){
  const g=$('#wizExp'); if(!g) return;
  STATE.exp=[...g.children].map(c=>{
    const when=$('.badge',c).textContent.trim().slice(0,9);
    const role=$('.exp-head [contenteditable]',c).textContent.trim()||'Job title';
    const org=$('div[contenteditable]',c).textContent.trim()||'@Company';
    const desc=$('.desc',c).textContent.trim()||'Describe impact, scale and results.';
    return {when,role,org,desc};
  });
}
function renderDone(body){
  body.innerHTML=`<div class="wtitle">All set!</div><div class="wsub">You can keep editing on the page or download a PDF.</div>`;
}

/* APPLY STATE TO CANVAS (idempotent) */
function applyStateToCanvas(skipFade){
  // clear everything
  $$('.node',stack).forEach(n=>n.remove());
  // header
  let header=null;
  if(STATE.layout==='header-top') header=headerTopBar();
  if(STATE.layout==='header-fancy') header=headerFancy();
  if(STATE.layout==='header-side') header=headerSidebar();
  stack.insertBefore(header, addAnchor);
  // avatar init
  $$('[data-avatar]',header).forEach(initAvatar);

  // name
  const nm=header.querySelector('.name'); if(nm) nm.textContent = STATE.name || 'YOUR NAME';

  // chips
  const chipsHost = isSidebar() ? $('#railChips',header) : null;
  if(chipsHost){
    chipsHost.innerHTML='';
    const entries=[['phone','fa-phone'],['email','fa-envelope'],['address','fa-location-dot'],['linkedin','fa-linkedin']];
    entries.forEach(([k,ico])=>{
      const v=STATE.chips[k]; if(!v) return;
      const d=document.createElement('div'); d.className='chip'; d.innerHTML=`<i class="fa-solid ${ico}"></i><span>${v}</span>`;
      chipsHost.appendChild(d);
    });
  }

  // skills
  const wantSkills = STATE.skills.length>0;
  if(wantSkills){
    if(STATE.skillsWhere==='sidebar' && isSidebar()){
      $('#railSkills',header).style.display='block';
      const g=$('#railSkills .grid-skills',header); g.innerHTML='';
      STATE.skills.forEach(s=> g.appendChild(makeSkillRow(s.type,s.label,s.value)));
    }else{
      const sNode=skillsSection(false);
      mainZone().appendChild(sNode);
      const g=$('.grid-skills',sNode);
      STATE.skills.forEach(s=> g.appendChild(makeSkillRow(s.type,s.label,s.value)));
      // move button should send to sidebar
      $('.move-where',sNode).title='Move to sidebar';
      $('.move-where',sNode).onclick=()=>{ STATE.skillsWhere='sidebar'; applyStateToCanvas(); };
    }
  }

  // education
  if(STATE.edu.length){
    const eNode=educationSection();
    mainZone().appendChild(eNode);
    const g=$('.edu-grid',eNode); STATE.edu.forEach(e=> g.appendChild(eduCard(e.kind,e.title,e.year,e.acad)));
  }

  // experience
  if(STATE.exp.length){
    const xNode=experienceSection();
    mainZone().appendChild(xNode);
    const g=$('.exp-list',xNode); STATE.exp.forEach(e=> g.appendChild(expCard(e.when,e.role,e.org,e.desc)));
  }

  // filter add menu options
  filterAddMenu();
  updatePH();
  moveAddAnchor();

  if(!skipFade){
    canvas.classList.add('blurred'); setTimeout(()=>canvas.classList.remove('blurred'),180);
  }
}

/* MENU toggles */
function toggleDD(dd){ dd.classList.toggle('open'); }
$('#ddFile > button').onclick=()=>toggleDD($('#ddFile'));
$('#ddLayout > button').onclick=()=>toggleDD($('#ddLayout'));
$('#ddTheme > button').onclick=()=>toggleDD($('#ddTheme'));
document.addEventListener('click',e=> [$('#ddFile'),$('#ddLayout'),$('#ddTheme')].forEach(dd=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); }));

/* START */
applyStateToCanvas(true);

/* Welcome stays until user chooses */
})();
</script>
</body>
</html>
