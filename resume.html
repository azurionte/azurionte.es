<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Easy Resume Builder</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
/* === tokens === */
:root{
  --accent:#8b5cf6; --accent2:#d946ef;
  --ink:#e6e8ef; --ink-d:#0e1117;
  --bg:#0e1117; --panel:#0f1420; --line:#23283b; --card:#ffffff;
  --shadow:0 10px 30px rgba(0,0,0,.25);
  --rail:300px;
  --star-gap:4px;          /* tighter stars */
  --skill-right:120px;     /* compact right column (stars/slider width) */
}
/* themes */
body[data-theme="coral"]{ --accent:#ff7b54; --accent2:#ffd166 }
body[data-theme="sea"]{ --accent:#4facfe; --accent2:#38d2ff }
body[data-theme="city"]{ --accent:#34d399; --accent2:#9ca3af }
body[data-theme="magentaPurple"]{ --accent:#c026d3; --accent2:#9333ea }
body[data-theme="magentaPink"]{ --accent:#ec4899; --accent2:#f97316 }
body[data-theme="blueGreen"]{ --accent:#22c1c3; --accent2:#2ecc71 }
body[data-theme="grayBlack"]{ --accent:#8892a6; --accent2:#414b57 }

/* === base === */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;display:grid;grid-template-rows:auto 1fr}
a{color:inherit;text-decoration:none}

/* === top bar === */
.nav{position:sticky;top:0;z-index:10000;display:flex;justify-content:center;gap:10px;align-items:center;padding:10px 14px;background:linear-gradient(180deg,#0b0f19,rgba(11,15,25,.85));border-bottom:1px solid #1d2336;backdrop-filter:blur(8px)}
.brand{font-weight:800}
.menu{display:flex;gap:10px;align-items:center;padding:6px 10px;border-radius:14px;background:#0f1420;border:1px solid #1f2540;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.mbtn{appearance:none;border:1px solid #2b324b;background:#12182a;color:#e6e8ef;padding:7px 10px;border-radius:12px;cursor:pointer}
.mbtn:hover{box-shadow:0 0 0 3px rgba(99,102,241,.25) inset}
.dropdown{position:relative}
.dropdown-menu{position:absolute;top:120%;left:0;background:#0f1420;border:1px solid var(--line);border-radius:12px;min-width:260px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:none;padding:10px;z-index:9999}
.dropdown.open .dropdown-menu{display:block}

/* theme pop */
.theme-pop{min-width:340px}
.theme-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.swatch{height:42px;border-radius:12px;border:1px solid #2b324b;cursor:pointer;background:linear-gradient(135deg,var(--a1),var(--a2));position:relative;overflow:hidden}
.swatch:active::after{content:"";position:absolute;inset:-60px;background:radial-gradient(circle at center, #fff6 0 8px, #fff0 9px) no-repeat center/120px 120px;animation:spark .6s ease}
@keyframes spark{from{opacity:1;transform:scale(.6)}to{opacity:0;transform:scale(1.6)}}
.swatch[data-k="coral"]{--a1:#ff7b54;--a2:#ffd166}
.swatch[data-k="sea"]{--a1:#4facfe;--a2:#38d2ff}
.swatch[data-k="city"]{--a1:#34d399;--a2:#9ca3af}
.swatch[data-k="magentaPurple"]{--a1:#c026d3;--a2:#9333ea}
.swatch[data-k="magentaPink"]{--a1:#ec4899;--a2:#f97316}
.swatch[data-k="blueGreen"]{--a1:#22c1c3;--a2:#2ecc71}
.swatch[data-k="grayBlack"]{--a1:#8892a6;--a2:#414b57}
.k-row{display:flex;align-items:center;gap:8px;margin-top:12px}
.k-row input[type=color]{width:28px;height:28px;border:0;border-radius:8px;cursor:pointer}
.switch{width:46px;height:26px;border-radius:999px;background:#2a314a;border:1px solid #3b4569;position:relative;cursor:pointer}
.switch::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#cfd6ff;transition:left .18s ease}
.switch.on{background:#3b82f6}
.switch.on::after{left:23px}

/* === canvas === */
#canvas{display:flex;justify-content:center;overflow:auto;padding:18px}
.page{background:var(--card);color:#111;width:860px;min-height:1200px;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35);position:relative}
[data-dark="1"] .page{background:#0d1220;color:#e6e8ef}
#sheet{padding:24px;min-height:1120px}
.stack{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px;align-content:start}
.rstack{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px;align-content:start} /* right side stack (sidebar layout) */

/* add button */
.add-squircle{grid-column:1/-1;display:flex;justify-content:center;padding:28px 0}
.add-dot{width:86px;height:86px;border-radius:22px;border:2px dashed #a3aed0;display:grid;place-items:center;color:#64748b;cursor:pointer;background:#fff;box-shadow:var(--shadow);font-size:28px;font-weight:900}
.add-dot:hover{border-color:#7c99ff;color:#7c99ff}

/* avatar */
.avatar{border-radius:999px;overflow:hidden;background:#d1d5db;position:relative;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.18);border:5px solid #fff;width:140px;height:140px}
.avatar input{display:none}
.avatar[data-empty="1"]::after{content:'+';position:absolute;inset:0;display:grid;place-items:center;color:#111;font-weight:900;font-size:30px;background:rgba(255,255,255,.6)}

/* layouts */
.node{grid-column:span 12}
.stickyTop{position:sticky;top:0;z-index:40}

/* Sidebar layout */
.sidebar-layout{display:grid;grid-template-columns:var(--rail) minmax(0,1fr);gap:16px;min-height:320px}
.sidebar-layout .rail{background:linear-gradient(135deg,var(--accent2),var(--accent));border-radius:14px;padding:18px 14px;display:flex;flex-direction:column;gap:12px;align-items:center;min-height:calc(100% - 0px)}
.sidebar-layout .rail .name{font-weight:900;font-size:26px;text-align:center}
.sidebar-layout .rail .chips{display:flex;flex-direction:column;gap:8px;width:100%}
.sidebar-layout .rail .sec-holder{width:100%;padding-top:6px}
.sidebar-layout [data-zone="main"]{padding:0}
.sidebar-layout [data-main-stack]{padding:0}

/* Top bar */
.topbar{border-radius:14px;background:linear-gradient(135deg,var(--accent2),var(--accent));padding:16px;min-height:160px}
.topbar-grid{display:grid;grid-template-columns:60% 40%;align-items:center;gap:18px}
.topbar .name{font-weight:900;font-size:34px;margin:0;text-align:left}
.topbar .right{display:flex;justify-content:flex-end}
.topbar .right .avatar{width:120px;height:120px;border-width:4px}

/* Fancy top */
.fancy{border-radius:14px}
.fancy .hero{border-radius:14px;padding:18px 14px 26px;min-height:200px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;flex-direction:column;align-items:center}
.fancy .name{font-weight:900;font-size:34px;margin:0;text-align:center}
.fancy .chip-grid{display:grid;grid-template-columns:1fr 1fr;column-gap:72px;row-gap:10px;margin:8px auto 0;max-width:740px}
.fancy .avatar-float{position:absolute;left:50%;transform:translateX(-50%);width:140px;height:140px;top:140px;z-index:30}
.fancy .below{height:88px}

/* sections (cards) */
.sec{background:#f7f9ff;border:1px solid #ebf0ff;border-radius:14px;padding:12px;position:relative}
[data-dark="1"] .sec{background:#0f1420;border-color:#1f2a44}
body[data-mat="glass"] .sec,
body[data-mat="glass"] .node:not([data-locked="1"]){background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border-color:#ffffff22}
[data-dark="1"][data-mat="glass"] .sec{background:#ffffff12}

/* section toolbar */
.tools{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.tbtn{width:30px;height:30px;border-radius:999px;background:#0b1224;border:1px solid #1d2950;color:#e6e8ef;display:grid;place-items:center;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.35);font-size:14px}
.preview .tools{display:none!important}

/* title */
.stitle{display:flex;align-items:center;gap:10px;justify-content:center;font-weight:800}
.stitle .u{height:4px;border-radius:999px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:160px;margin-top:8px;margin-inline:auto}

/* chips */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid rgba(0,0,0,.08)}
.chip .rm{display:none}
.chip i{width:16px;text-align:center}

/* skills (canvas) */
.grid-skills{display:grid;gap:8px}
.grid-skills.cols-2{grid-template-columns:1fr 1fr}
.skill{display:grid;grid-template-columns:1fr var(--skill-right);align-items:center;gap:8px;padding:2px 0}
.skill .label{display:flex;align-items:center;gap:8px}
.stars{display:inline-flex;gap:var(--star-gap);justify-content:flex-end}
.star{cursor:pointer;width:16px;height:16px;fill:#d1d5db}
.star.active{fill:#f59e0b}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:999px;background:linear-gradient(90deg,var(--accent2),var(--accent));outline:1px solid rgba(0,0,0,.22)}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer}

/* edu/exp helpers */
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:color-mix(in srgb, var(--accent) 16%, #fff);border:1px solid color-mix(in srgb, var(--accent) 40%, #0000)}
.exp-tile{background:color-mix(in srgb, var(--accent) 12%, #fff)}

/* welcome */
#welcome{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);z-index:20000}
.wcard{width:min(880px,94vw);min-height:360px;background:#0f1420;border:1px solid #1f2540;border-radius:18px;padding:32px;color:#e6e8ef;box-shadow:0 40px 140px rgba(0,0,0,.6);display:grid;justify-items:center;gap:16px}
.wtitle{font-weight:900;font-size:22px;margin:0 0 6px;text-align:center}
.wgrid{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start;justify-items:center}
.wcol{display:grid;justify-items:center;gap:8px;width:300px;height:70px}
.wbtn{appearance:none;border:1px solid #2b324b;background:#12182a;color:#e6e8ef;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 10px 24px rgba(0,0,0,.3)}
.wbtn.primary{background:linear-gradient(135deg,var(--accent2),var(--accent));color:#111;border:none}

/* wizard (kept minimal here) */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:21000}
.wiz{width:min(1040px,96vw);display:grid;grid-template-columns:260px 1fr;background:#0f1420;border:1px solid #1f2540;border-radius:18px;color:#e6e8ef;box-shadow:0 40px 140px rgba(0,0,0,.6);overflow:hidden}
.wiz-left{background:#0c111f;border-right:1px solid #1b2340;padding:16px}
.step-list{display:grid;gap:8px}
.step{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;color:#c9d1ff80}
.step.on{color:#e8ecff;background:#131a31}
.step .dot{width:8px;height:8px;border-radius:50%;background:#2e3b66}
.step.done .dot{background:#26d07c}
.wiz-right{padding:20px 22px;display:flex;flex-direction:column;min-height:480px}
#wizBody{flex:1}
.navline{display:flex;gap:10px;justify-content:flex-end}
.wipt{background:#0c1328;color:#e7ebff;border:1px solid #243057;outline:none;border-radius:10px;padding:10px 12px;width:100%}
.wipt::placeholder{color:#95a0c7}

/* mocks */
.mock{flex:1;min-width:220px;min-height:130px;background:#0c1324;border:1px solid #1f2540;border-radius:18px;padding:14px;cursor:pointer;position:relative;transition:transform .15s ease}
.mock:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(0,0,0,.35)}
.mock.sel{outline:2px solid #ffb86c}
.mock .hero{border-radius:12px;background:linear-gradient(135deg,#5b6fb7,#2f3d7a)}
.mock .line{height:8px;border-radius:999px;background:#2b375f}
.mock.sidebar .hero{position:absolute;inset:14px auto 14px 14px;width:30%}
.mock.sidebar .pp{position:absolute;left:34px;top:34px;width:42px;height:42px;border-radius:50%;background:#cfd6ff;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.35)}
.mock.sidebar .txt{position:absolute;left:38%;right:20px;top:26px;display:grid;gap:10px}
.mock.fancy .hero{height:64px;margin:8px}
.mock.fancy .pp{position:absolute;left:50%;transform:translateX(-50%);top:58px;width:56px;height:56px;border-radius:50%;background:#cfd6ff;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.35)}
.mock.fancy .txt{position:absolute;left:26px;right:26px;top:120px;display:grid;gap:10px}
.mock.topbar .hero{height:64px;margin:8px}
.mock.topbar .pp{position:absolute;right:31px;top:22px;width:56px;height:56px;border-radius:50%;background:#cfd6ff;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.35)}
.mock.topbar .txt{position:absolute;left:26px;right:120px;top:28px;display:grid;gap:10px}

/* add menu */
.pop{position:fixed;background:#0f1420;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:10px;display:none;z-index:18000}
.pop.open{display:block}
.pop .tray{display:flex;gap:10px}
.pop .sq{width:48px;height:48px;border-radius:12px;border:1px solid #293255;background:#12182a;color:#e6e8ef;display:grid;place-items:center;cursor:pointer;box-shadow:0 12px 32px rgba(0,0,0,.35)}
.pop .sq:hover{box-shadow:0 0 0 3px rgba(124,153,255,.25) inset}

/* printing & preview */
.preview .add-dot,.preview .tip,.preview .tools,.preview .fmtbar,.preview .handle,.preview .chip .rm{display:none!important}
@media print{ .nav,#welcome,#wizard,.pop{display:none!important} .page{box-shadow:none} }
</style>
</head>
<body data-theme="magentaPurple" data-mat="paper">
  <!-- top bar -->
  <div class="nav">
    <span class="brand">Easy Resume</span>
    <div class="menu">
      <div class="dropdown" id="ddFile">
        <button class="mbtn" type="button">File ▾</button>
        <div class="dropdown-menu">
          <button id="saveJSON" type="button"><i class="fa-solid fa-floppy-disk"></i> Save project</button>
          <button id="loadJSON" type="button"><i class="fa-solid fa-folder-open"></i> Load project</button>
          <button id="startScratch" type="button"><i class="fa-solid fa-eraser"></i> Start from scratch</button>
        </div>
      </div>

      <div class="dropdown" id="ddLayout">
        <button class="mbtn" type="button">Layout options ▾</button>
        <div class="dropdown-menu" style="width:340px">
          <div id="layoutQuick" class="wrow" style="flex-direction:column">
            <div class="mock sidebar" data-layout="header-side">
              <div class="hero"></div><div class="pp"></div>
              <div class="txt"><div class="line" style="width:60%"></div><div class="line" style="width:40%"></div><div class="line" style="width:56%"></div></div>
            </div>
            <div class="mock fancy" data-layout="header-fancy">
              <div class="hero"></div><div class="pp"></div>
              <div class="txt"><div class="line" style="width:70%"></div><div class="line" style="width:48%"></div></div>
            </div>
            <div class="mock topbar" data-layout="header-top">
              <div class="hero"></div><div class="pp"></div>
              <div class="txt"><div class="line" style="width:60%"></div><div class="line" style="width:40%"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="dropdown" id="ddTheme">
        <button class="mbtn" type="button">Theme ▾</button>
        <div class="dropdown-menu theme-pop">
          <div class="theme-row" id="themeRow">
            <div class="swatch" data-k="coral"></div><div class="swatch" data-k="sea"></div><div class="swatch" data-k="city"></div>
            <div class="swatch" data-k="magentaPurple"></div><div class="swatch" data-k="magentaPink"></div><div class="swatch" data-k="blueGreen"></div>
            <div class="swatch" data-k="grayBlack"></div>
          </div>
          <div class="k-row"><span>Dark mode</span><div id="darkToggle" class="switch"></div></div>
          <div class="k-row"><span>Material</span>
            <button class="mbtn" id="matPaper" type="button">Paper</button>
            <button class="mbtn" id="matGlass" type="button">Glass</button>
          </div>
          <div style="border-top:1px solid #23283b;margin:10px 0"></div>
          <div class="k-row"><span>Custom gradient</span>
            <input type="color" id="c1" value="#8b5cf6"><input type="color" id="c2" value="#d946ef">
            <button class="mbtn" id="applyGrad" type="button">Apply</button>
          </div>
        </div>
      </div>

      <button id="pdfBtn" class="mbtn" type="button"><i class="fa-solid fa-download"></i> Download</button>
      <button id="togglePreview" class="mbtn" type="button">Preview</button>
    </div>
  </div>

  <!-- canvas -->
  <div id="canvas">
    <div class="page" id="page">
      <div id="sheet">
        <div class="stack" id="stack">
          <div class="add-squircle" id="canvasAdd" style="display:none"><div class="add-dot" id="dotAdd">+</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- floating add menu -->
  <div class="pop" id="addMenu"><div class="tray" id="addTray"></div></div>

  <!-- welcome -->
  <div id="welcome" role="dialog" aria-modal="true">
    <div class="wcard">
      <div class="wtitle">Welcome to the Easy Resume Builder</div>
      <div class="wgrid">
        <div class="wcol">
          <button class="wbtn primary" id="startWizard" type="button">Wizard</button>
          <div style="opacity:.8">Guided step-by-step set-up.</div>
        </div>
        <div class="wcol">
          <button class="wbtn" id="startBlank" type="button">Manual mode</button>
          <div style="opacity:.8">Start from scratch, arrange freely.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- wizard (minimal shell retained) -->
  <div id="wizard" class="modal">
    <div class="wiz">
      <div class="wiz-left"><div class="step-list" id="stepList"></div></div>
      <div class="wiz-right">
        <div id="wizBody"></div>
        <div class="navline">
          <button class="mbtn" id="wizStartOver" style="margin-right:auto;display:none" type="button">Start over</button>
          <button class="mbtn" id="wizBack" type="button">Back</button>
          <button class="mbtn" id="wizNext" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#111;border:none" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

<script>
(()=>{'use strict';
const $=(s,r)=> (r||document).querySelector(s);
const $$=(s,r)=> Array.from((r||document).querySelectorAll(s));

/* ========== STATE ========== */
const S={
  layout:null, theme:'magentaPurple', dark:false, mat:'paper',
  contact:{name:'',phone:'',email:'',address:'',linkedin:''},
  avatar:null,                       // dataURL for avatar
  skillsInSidebar:false,
  skills:[], edu:[], exp:[]
};

/* ========== ELEMENTS ========== */
const stack=$("#stack"), addWrap=$("#canvasAdd"), addBtn=$("#dotAdd"), addMenu=$("#addMenu"), addTray=$("#addTray");
const ddFile=$("#ddFile"), ddLayout=$("#ddLayout"), ddTheme=$("#ddTheme");
const pdfBtn=$("#pdfBtn"), togglePrev=$("#togglePreview");
const welcome=$("#welcome"), wizard=$("#wizard");
const stepList=$("#stepList"), wizBody=$("#wizBody"), wizBack=$("#wizBack"), wizNext=$("#wizNext"), wizStartOver=$("#wizStartOver");

/* ========== DROPDOWNS ========== */
const toggleDD = dd => dd.classList.toggle('open');
[ddFile,ddLayout,ddTheme].forEach(dd=> dd.querySelector('button').onclick=()=>toggleDD(dd));
document.addEventListener('click',e=>[ddFile,ddLayout,ddTheme].forEach(dd=>{if(!dd.contains(e.target)) dd.classList.remove('open')}));

/* ========== THEME CONTROLS ========== */
$$('.swatch',ddTheme).forEach(s=> s.onclick=()=>{ setTheme(s.dataset.k); s.dispatchEvent(new Event('spark')); });
$('#darkToggle').onclick=()=>{ $('#darkToggle').classList.toggle('on'); S.dark=$('#darkToggle').classList.contains('on'); refreshTheme(); applyChipThemeAll(); };
$('#matPaper').onclick=()=>{ S.mat='paper'; refreshTheme(); applyChipThemeAll(); };
$('#matGlass').onclick=()=>{ S.mat='glass'; refreshTheme(); applyChipThemeAll(); };
$('#applyGrad').onclick=()=>{ setCustomGradient($('#c1').value,$('#c2').value); };

/* ========== PREVIEW/PRINT ========== */
togglePrev.onclick=()=>{ const on=!document.body.classList.contains('preview'); document.body.classList.toggle('preview',on); togglePrev.textContent=on?'Exit preview':'Preview'; }
pdfBtn.onclick=()=>{ const was=document.body.classList.contains('preview'); document.body.classList.add('preview'); setTimeout(()=>{ window.print(); if(!was) setTimeout(()=>document.body.classList.remove('preview'),180); },60); };

/* ========== WELCOME FIXED ========== */
function openWizard(){ wizard.style.display='grid'; welcome.style.display='none'; buildWizard(); }
$('#startWizard').addEventListener('click',e=>{ e.stopPropagation(); openWizard(); });
$('#startBlank').addEventListener('click',e=>{ e.stopPropagation(); welcome.style.display='none'; ensurePlusAtEnd(); });

/* ========== UTILS ========== */
const sectionHost=()=> (S.layout==='side' ? ($('[data-main-stack]')||stack) : stack);
function headerNode(){ return stack.querySelector('[data-header]')?.closest('.node'); }
function ensurePlusAtEnd(){
  const host=sectionHost();
  if(addWrap.parentElement!==host) host.appendChild(addWrap);
  addWrap.style.display='flex';
}
function moveAddNear(el){
  const r=el.getBoundingClientRect(), m=addMenu;
  const below=(window.innerHeight-r.bottom)>160;
  m.style.left=(r.left+window.scrollX)+'px';
  m.style.top=(below? (r.bottom+10):(r.top-10-(m.offsetHeight||120)))+'px';
}
function chipMode(){ return (S.mat==='glass')?'glass': (S.dark?'dark':'light'); }
function tintForTheme(){ const darkThemes=['grayBlack','magentaPurple']; return darkThemes.includes(S.theme)?'lightText':'darkText'; }

/* ========== AVATAR ========== */
function initAvatars(root){
  $$('[data-avatar]',root).forEach(w=>{
    // avoid duplicate canvas
    if(!w.querySelector('canvas')){
      const c=document.createElement('canvas'); c.width=140; c.height=140; w.appendChild(c);
    }
    const input=w.querySelector('input');
    w.onclick=(e)=>{ if(e.target===input) return; input.click(); };
    input.onchange=()=>{ const f=input.files?.[0]; if(!f) return; const img=new Image(); img.onload=()=>{ drawAvatarToLabel(w,img); S.avatar = drawAvatarToDataURL(img); w.setAttribute('data-empty','0'); }; img.src=URL.createObjectURL(f); };
    // hydrate from state
    if(S.avatar){ const img=new Image(); img.onload=()=>{ drawAvatarToLabel(w,img); w.setAttribute('data-empty','0'); }; img.src=S.avatar; }
  });
}
function drawAvatarToLabel(label,img){
  const canvas=label.querySelector('canvas'); const ctx=canvas.getContext('2d',{willReadFrequently:true});
  const s=Math.max(canvas.width/img.width, canvas.height/img.height);
  const dw=img.width*s, dh=img.height*s, dx=(canvas.width-dw)/2, dy=(canvas.height-dh)/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save(); ctx.beginPath(); ctx.arc(canvas.width/2,canvas.height/2,canvas.width/2,0,Math.PI*2); ctx.clip(); ctx.imageSmoothingQuality='high';
  ctx.drawImage(img,dx,dy,dw,dh); ctx.restore();
}
function drawAvatarToDataURL(img){
  const c=document.createElement('canvas'); c.width=140; c.height=140; const ctx=c.getContext('2d');
  const s=Math.max(c.width/img.width, c.height/img.height);
  const dw=img.width*s, dh=img.height*s, dx=(c.width-dw)/2, dy=(c.height-dh)/2;
  ctx.save(); ctx.beginPath(); ctx.arc(c.width/2,c.height/2,c.width/2,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,dx,dy,dw,dh); ctx.restore();
  return c.toDataURL('image/png');
}

/* ========== CHIPS THEME ========== */
function applyChipTheme(el){
  const mode=chipMode(), tint=tintForTheme();
  el.style.background=''; el.style.color='';
  if(mode==='glass'){ el.style.background='rgba(255,255,255,.10)'; el.style.backdropFilter='blur(6px)'; el.style.border='1px solid #ffffff28'; el.style.color=(tint==='lightText')?'#fff':'#111'; }
  else if(mode==='dark'){ el.style.background='#0c1324'; el.style.color='#e6ecff'; el.style.border='1px solid #1f2a44'; }
  else { el.style.background='#fff'; el.style.color='#111'; el.style.border='1px solid rgba(0,0,0,.08)'; }
  const ic=el.querySelector('i'); if(ic){ ic.style.color='var(--accent)'; }
}
function applyChipThemeAll(){ $$('.chip').forEach(applyChipTheme); }

/* ========== THEME API ========== */
function setTheme(k){ S.theme=k; refreshTheme(); applyChipThemeAll(); }
function setCustomGradient(a,b){ document.documentElement.style.setProperty('--accent',a); document.documentElement.style.setProperty('--accent2',b); applyChipThemeAll(); }
function refreshTheme(){ document.body.setAttribute('data-theme', S.theme||'magentaPurple'); document.body.setAttribute('data-dark', S.dark?'1':'0'); document.body.setAttribute('data-mat', S.mat||'paper'); }

/* ========== HEADER CREATION (with FLIP) ========== */
function createHeader(kind, prevRect){
  // remove old header node (not sections)
  const old=headerNode(); if(old) old.remove();

  // new header node
  const node=document.createElement('div'); node.className='node stickyTop'; node.setAttribute('data-locked','1');
  if(kind==='header-side'){
    node.innerHTML=`<div class="sidebar-layout" data-header>
      <div class="rail">
        <label class="avatar" data-avatar ${S.avatar? '':'data-empty="1"'}><input type="file" accept="image/*"></label>
        <div class="name" contenteditable>YOUR NAME</div>
        <div class="chips" data-info></div>
        <div class="sec-holder" data-rail-sections></div>
      </div>
      <div data-zone="main">
        <div class="rstack" data-main-stack></div>
      </div>
    </div>`;
  }
  if(kind==='header-fancy'){
    node.innerHTML=`<div class="fancy" data-header>
      <div class="hero">
        <h1 class="name" contenteditable>YOUR NAME</h1>
        <div class="chip-grid"><div class="chips" data-info-left></div><div class="chips" data-info-right></div></div>
      </div>
      <div class="avatar-float"><label class="avatar" data-avatar ${S.avatar? '':'data-empty="1"'}><input type="file" accept="image/*"></label></div>
      <div class="below"></div>
    </div>`;
  }
  if(kind==='header-top'){
    node.innerHTML=`<div class="topbar" data-header>
      <div class="topbar-grid">
        <div class="left">
          <h1 class="name" contenteditable>YOUR NAME</h1>
          <div class="chips" data-info></div>
        </div>
        <div class="right">
          <label class="avatar" data-avatar ${S.avatar? '':'data-empty="1"'} style="width:120px;height:120px;border-width:4px"><input type="file" accept="image/*"></label>
        </div>
      </div>
    </div>`;
  }

  // insert before sections
  const first=stack.firstElementChild;
  stack.insertBefore(node, first);

  // hydrate avatar + contact
  initAvatars(node);
  S.layout = (kind==='header-side')?'side' : (kind==='header-fancy')?'fancy':'top';
  saveContact();
  refreshTheme(); applyChipThemeAll();

  // FLIP morph (measure new -> invert)
  if(prevRect){
    const nh=node.getBoundingClientRect();
    const dx=prevRect.left-nh.left, dy=prevRect.top-nh.top, sx=prevRect.width/nh.width, sy=prevRect.height/nh.height;
    node.style.transform=`translate(${dx}px,${dy}px) scale(${sx},${sy})`; node.style.transformOrigin='top left'; node.style.transition='transform .35s ease, opacity .35s ease'; node.style.opacity='0.6';
    requestAnimationFrame(()=>{ node.style.transform='translate(0,0) scale(1,1)'; node.style.opacity='1'; });
    setTimeout(()=>{ node.style.transition=''; node.style.transform=''; },380);
  }

  // place "+" into proper host and rerender sections to correct side
  ensurePlusAtEnd();
  rerenderAll();
}

function morphTo(kind){
  const old=headerNode(); const rect=old? old.getBoundingClientRect():null;
  createHeader(kind, rect);
}

/* ========== CONTACT CHIPS ========== */
function addChip(icon, text){
  const chip=document.createElement('div'); chip.className='chip';
  chip.innerHTML=`<i class="${icon}"></i><span>${text}</span>`;
  applyChipTheme(chip);
  return chip;
}
function saveContact(){
  const h=headerNode(); if(!h) return;
  const nameEl=h.querySelector('.name'); if(nameEl) nameEl.textContent=S.contact.name||'YOUR NAME';
  const list=[];
  if(S.contact.phone) list.push(addChip('fa-solid fa-phone', S.contact.phone));
  if(S.contact.email) list.push(addChip('fa-solid fa-envelope', S.contact.email));
  if(S.contact.address) list.push(addChip('fa-solid fa-location-dot', S.contact.address));
  if(S.contact.linkedin) list.push(addChip('fa-brands fa-linkedin','linkedin.com/in/'+S.contact.linkedin));
  const areas=[...h.querySelectorAll('[data-info],[data-info-left],[data-info-right]')];
  areas.forEach(a=>a.innerHTML='');
  if(h.querySelector('[data-info-left]')){
    const L=h.querySelector('[data-info-left]'), R=h.querySelector('[data-info-right]');
    list.forEach((c,i)=> (i%2?R:L).appendChild(c));
  }else{
    const box=h.querySelector('[data-info]'); list.forEach(c=>box.appendChild(c));
  }
}

/* ========== SECTION TOOLBAR & DRAG ========== */
function toolbar(sectionKey, onDelete){
  const t=document.createElement('div'); t.className='tools';
  const drag=document.createElement('button'); drag.className='tbtn'; drag.title='Drag'; drag.innerHTML='<i class="fa-solid fa-grip-vertical"></i>';
  const del=document.createElement('button'); del.className='tbtn'; del.title='Delete section'; del.innerHTML='&times;';
  t.appendChild(drag); t.appendChild(del);
  del.onclick=(e)=>{ e.stopPropagation(); onDelete(); updatePlusMenu(); };
  // drag by handle only
  drag.setAttribute('draggable','true');
  drag.addEventListener('dragstart',ev=>{
    const host=sectionHost();
    const node=t.closest('.node');
    ev.dataTransfer.setData('text/section', sectionKey);
    ev.dataTransfer.setData('text/index', [...host.children].indexOf(node));
    ev.dataTransfer.effectAllowed='move';
    host.querySelectorAll('.node').forEach(n=>{
      n.addEventListener('dragover',overHandler);
      n.addEventListener('drop',dropHandler);
    });
  });
  function overHandler(e){ e.preventDefault(); }
  function dropHandler(e){
    e.preventDefault();
    const host=sectionHost();
    const from=+e.dataTransfer.getData('text/index');
    const src=[...host.children][from];
    const dst=this;
    if(!src || !dst || src===dst) return;
    host.insertBefore(src, dst);
  }
  return t;
}

/* ========== RENDER: SKILLS ========== */
function renderSkills(){
  $$('[data-section="skills"]').forEach(n=>n.remove());
  if(!S.skills.length) return;

  const inSide = (S.skillsInSidebar && S.layout==='side');
  const host = inSide ? $('[data-rail-sections]') : sectionHost();

  const node=document.createElement('div'); node.className='node'; node.dataset.section='skills';
  const card=document.createElement('div'); card.className='sec';
  card.innerHTML=`<div class="stitle"><i class="fa-solid fa-layer-group"></i><div>Skills</div></div><div class="u"></div>
  <div class="tip" ${inSide?'style="display:none"':''}>Use ★ or the slider to rate your confidence. You can add languages, tools, abilities—anything.</div>
  <div class="grid-skills ${inSide?'':'cols-2'}" data-sgrid></div>`;
  // toolbar
  card.appendChild(toolbar('skills',()=>{ S.skills=[]; renderSkills(); }));
  const grid=card.querySelector('[data-sgrid]');

  // rows
  S.skills.forEach(it=>{
    const row=document.createElement('div'); row.className='skill';
    row.innerHTML=`<div class="label"><span>${it.label||'Skill'}</span></div><div class="right"></div>`;
    const R=row.querySelector('.right');
    if(it.type==='star'){
      const s=document.createElement('div'); s.className='stars';
      for(let i=1;i<=5;i++){
        const svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('viewBox','0 0 24 24'); svg.classList.add('star'); if(i<=(+it.value||0)) svg.classList.add('active');
        svg.innerHTML='<path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>';
        svg.onclick=()=>{ it.value=i; s.querySelectorAll('.star').forEach((e,ix)=>e.classList.toggle('active',ix<i)); };
        s.appendChild(svg);
      }
      R.appendChild(s);
    }else{
      const r=document.createElement('input'); r.type='range'; r.min=0; r.max=100; r.value=+it.value||50; r.oninput=()=>it.value=r.value; R.appendChild(r);
    }
    grid.appendChild(row);
  });

  // mount
  node.appendChild(card);
  if(inSide){
    const wrap=document.createElement('div'); wrap.className='node'; wrap.appendChild(card); host.appendChild(wrap);
  }else{
    host.insertBefore(node, addWrap);
  }
}

/* ========== RENDER: EDUCATION ========== */
function renderEdu(){
  $$('[data-section="edu"]').forEach(n=>n.remove());
  if(!S.edu.length) return;

  const host=sectionHost();
  const node=document.createElement('div'); node.className='node'; node.dataset.section='edu';
  const card=document.createElement('div'); card.className='sec';
  card.innerHTML=`<div class="stitle"><i class="fa-solid fa-graduation-cap"></i><div>Education</div></div><div class="u"></div>
  <div class="edu-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px" data-egrid></div>`;
  card.appendChild(toolbar('edu',()=>{ S.edu=[]; renderEdu(); updatePlusMenu(); }));
  const grid=card.querySelector('[data-egrid]');

  S.edu.forEach(item=>{
    const c=document.createElement('div'); c.className='sec';
    const icon = item.kind==='degree' ? '<i class="fa-solid fa-graduation-cap" style="color:var(--accent)"></i>' : '<i class="fa-solid fa-scroll" style="color:var(--accent2)"></i>';
    c.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-weight:700">${icon}<span>${item.title||'Title'}</span></div>
      <div><span class="badge">${(item.year||'2018–2022').slice(0,9)}</span></div>
      <div style="margin-top:6px">${item.academy||'Academy name (wraps to two lines if needed)'}</div>`;
    grid.appendChild(c);
  });

  node.appendChild(card);
  host.insertBefore(node, addWrap);
}

/* ========== RENDER: EXPERIENCE ========== */
function renderExp(){
  $$('[data-section="exp"]').forEach(n=>n.remove());
  if(!S.exp.length) return;

  const host=sectionHost();
  const node=document.createElement('div'); node.className='node'; node.dataset.section='exp';
  const card=document.createElement('div'); card.className='sec';
  card.innerHTML=`<div class="stitle"><i class="fa-solid fa-briefcase"></i><div>Work experience</div></div><div class="u"></div>
  <div class="exp-list" style="display:grid;gap:12px" data-xgrid></div>`;
  card.appendChild(toolbar('exp',()=>{ S.exp=[]; renderExp(); updatePlusMenu(); }));
  const grid=card.querySelector('[data-xgrid]');

  S.exp.forEach(x=>{
    const c=document.createElement('div'); c.className='sec exp-tile';
    c.innerHTML=`<div style="display:flex;align-items:center;gap:8px"><span class="badge">${(x.dates||'Jan 2022').slice(0,16)}</span><div style="font-weight:800;margin-left:6px">${x.role||'Job title'}</div></div>
      <div style="font-weight:700;color:#374151;margin-top:4px">${x.org||'@Company'}</div>
      <div style="margin-top:6px">${x.desc||'Describe impact, scale and results.'}</div>`;
    grid.appendChild(c);
  });

  node.appendChild(card);
  host.insertBefore(node, addWrap);
}

/* ========== RERENDER (after layout switch) ========== */
function rerenderAll(){
  renderSkills(); renderEdu(); renderExp(); updatePlusMenu();
}

/* ========== ADD MENU ========== */
function updatePlusMenu(){
  const haveSkills=!!$('[data-section="skills"]');
  const haveEdu=!!$('[data-section="edu"]');
  const haveExp=!!$('[data-section="exp"]');
  const all=haveSkills&&haveEdu&&haveExp;
  addWrap.style.display= all ? 'none' : 'flex';
}
function openAddMenuNear(btn){
  addTray.innerHTML='';
  const haveHeader=!!headerNode();
  if(!haveHeader){
    addTray.innerHTML=`<div class="sq" data-add="header-side" title="Sidebar"><i class="fa-solid fa-table-columns"></i></div>
      <div class="sq" data-add="header-fancy" title="Top fancy"><i class="fa-solid fa-sparkles"></i></div>
      <div class="sq" data-add="header-top" title="Top bar"><i class="fa-solid fa-grip-lines"></i></div>`;
  }else{
    if(!S.skills.length) addTray.innerHTML+=`<div class="sq" data-add="skills" title="Skills"><i class="fa-solid fa-layer-group"></i></div>`;
    if(!S.edu.length)   addTray.innerHTML+=`<div class="sq" data-add="edu" title="Education"><i class="fa-solid fa-user-graduate"></i></div>`;
    if(!S.exp.length)   addTray.innerHTML+=`<div class="sq" data-add="exp" title="Experience"><i class="fa-solid fa-briefcase"></i></div>`;
  }
  if(!addTray.children.length){ addWrap.style.display='none'; return; }
  addMenu.classList.add('open'); moveAddNear(btn);
}
addBtn.onclick=(e)=>openAddMenuNear(e.currentTarget);
document.addEventListener('click',e=>{ if(addMenu.classList.contains('open') && !addMenu.contains(e.target) && e.target!==addBtn) addMenu.classList.remove('open'); });
addTray.addEventListener('click',e=>{
  const k=e.target.closest('.sq')?.dataset.add; if(!k) return;
  addMenu.classList.remove('open');
  if(k.startsWith('header')) morphTo(k);
  if(k==='skills'){ if(!S.skills.length) S.skills=[{type:'star',label:'Skill',value:3},{type:'slider',label:'Skill',value:50}]; renderSkills(); }
  if(k==='edu'){ if(!S.edu.length) S.edu=[{kind:'course',year:'2018–2022',academy:'Academy name (wraps to two lines if needed)',title:'Course'}, {kind:'degree',year:'2014–2018',academy:'University name',title:'Degree'}]; renderEdu(); }
  if(k==='exp'){ if(!S.exp.length) S.exp=[{dates:'Jan 2022 – Now',role:'Job title',org:'@Company',desc:'Describe impact, scale and results.'}]; renderExp(); }
  updatePlusMenu();
});

/* ========== LAYOUT QUICK PICK (menu) ========== */
$('#layoutQuick').addEventListener('click',e=>{
  const k=e.target.closest('.mock')?.dataset.layout; if(!k) return;
  morphTo(k); ddLayout.classList.remove('open');
});

/* ========== WIZARD (trimmed to layout+theme+contact+done) ========== */
const STEPS=[{k:'layout',label:'Layout'},{k:'theme',label:'Theme'},{k:'contact',label:'Profile data'},{k:'done',label:'Done'}];
let stepIdx=0, backCount=0;

function buildWizard(){
  stepList.innerHTML=''; STEPS.forEach((s,i)=>{ const el=document.createElement('div'); el.className='step'; el.dataset.i=i; el.innerHTML=`<div class="dot"></div><div>${s.label}</div>`; stepList.appendChild(el); });
  renderStep();
}
function markSteps(){ $$('.step',stepList).forEach((el,i)=>{ el.classList.toggle('on',i===stepIdx); el.classList.toggle('done',i<stepIdx); }); }
function renderStep(){
  markSteps(); wizStartOver.style.display=(backCount>=2?'inline-flex':'none');
  const s=STEPS[stepIdx].k;

  if(s==='layout'){
    wizBody.innerHTML=`<div class="wtitle">Choose your layout</div>
    <div class="wrow" style="gap:14px;flex-wrap:wrap">
      <div class="mock sidebar ${S.layout==='side'?'sel':''}" data-layout="header-side"><div class="hero"></div><div class="pp"></div><div class="txt"><div class="line" style="width:60%"></div><div class="line" style="width:40%"></div><div class="line" style="width:56%"></div></div></div>
      <div class="mock fancy ${S.layout==='fancy'?'sel':''}" data-layout="header-fancy"><div class="hero"></div><div class="pp"></div><div class="txt"><div class="line" style="width:70%"></div><div class="line" style="width:48%"></div></div></div>
      <div class="mock topbar ${S.layout==='top'?'sel':''}" data-layout="header-top"><div class="hero"></div><div class="pp"></div><div class="txt"><div class="line" style="width:60%"></div><div class="line" style="width:40%"></div></div></div>
    </div>
    <div class="k-row" style="margin-top:12px"><button class="mbtn" id="wizAddPhoto" type="button"><i class="fa-solid fa-camera"></i> Upload photo</button></div>`;
    $$('.mock',wizBody).forEach(m=> m.onclick=()=>{ $$('.mock',wizBody).forEach(x=>x.classList.remove('sel')); m.classList.add('sel'); morphTo(m.dataset.layout); });
    $('#wizAddPhoto').onclick=()=>{ const a=headerNode()?.querySelector('[data-avatar] input'); if(a) a.click(); };
  }

  if(s==='theme'){
    wizBody.innerHTML=`<div class="wtitle">Choose a color theme</div>
      <div class="theme-row">${['coral','sea','city','magentaPurple','magentaPink','blueGreen','grayBlack'].map(k=>`<div class="swatch" data-k="${k}"></div>`).join('')}</div>
      <div class="k-row"><span>Dark mode</span><div id="wizDark" class="switch ${S.dark?'on':''}"></div></div>
      <div class="k-row"><span>Material</span><button class="mbtn" id="wizPaper" type="button">Paper</button><button class="mbtn" id="wizGlass" type="button">Glass</button></div>
      <div class="k-row"><span>Custom gradient</span><input type="color" id="w1" value="#8b5cf6"><input type="color" id="w2" value="#d946ef"><button class="mbtn" id="wApply" type="button">Apply</button></div>`;
    $$('.swatch',wizBody).forEach(s=> s.onclick=()=>{ setTheme(s.dataset.k); s.dispatchEvent(new Event('spark')); });
    $('#wizDark').onclick=()=>{ $('#wizDark').classList.toggle('on'); S.dark=$('#wizDark').classList.contains('on'); refreshTheme(); applyChipThemeAll(); };
    $('#wizPaper').onclick=()=>{ S.mat='paper'; refreshTheme(); applyChipThemeAll(); };
    $('#wizGlass').onclick=()=>{ S.mat='glass'; refreshTheme(); applyChipThemeAll(); };
    $('#wApply').onclick=()=>{ setCustomGradient($('#w1').value,$('#w2').value); };
  }

  if(s==='contact'){
    wizBody.innerHTML=`<div class="wtitle">Profile data</div><div class="wsub">Only filled fields will appear.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <input class="wipt" id="nm" placeholder="Full name" value="${S.contact.name||''}">
      <input class="wipt" id="ph" placeholder="Phone" value="${S.contact.phone||''}">
      <input class="wipt" id="em" placeholder="Email" value="${S.contact.email||''}">
      <input class="wipt" id="ad" placeholder="City, Country" value="${S.contact.address||''}">
      <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center"><span style="opacity:.7">linkedin.com/in/</span><input class="wipt" id="ln" placeholder="username" style="flex:1" value="${S.contact.linkedin||''}"></div>
    </div>`;
    ['nm','ph','em','ad','ln'].forEach(id=> $('#'+id).oninput=()=>{ S.contact={ name:$('#nm').value, phone:$('#ph').value, email:$('#em').value, address:$('#ad').value, linkedin:$('#ln').value }; saveContact(); }));
  }

  if(s==='done'){
    wizBody.innerHTML=`<div class="wtitle" style="text-align:center">All set ✨</div><div class="wsub" style="text-align:center">You can keep editing on the canvas.</div>`;
    wizNext.textContent='Finish';
  }else{ wizNext.textContent='Next'; }
}

wizBack.onclick=()=>{ if(stepIdx>0){ stepIdx--; backCount++; renderStep(); } };
wizStartOver.onclick=()=>{ Object.assign(S,{contact:{name:'',phone:'',email:'',address:'' ,linkedin:''},skills:[],edu:[],exp:[]}); stepIdx=0; backCount=0; buildWizard(); rerenderAll(); };
wizNext.onclick=()=>{
  const cur=STEPS[stepIdx].k;
  if(cur==='done'){ wizard.style.display='none'; welcome.remove(); ensurePlusAtEnd(); return; }
  if(stepIdx<STEPS.length-1){ stepIdx++; renderStep(); }
};

/* ========== INITIALIZE ========== */
function initialClean(){ /* keep canvas clean behind welcome */ }
initialClean();
refreshTheme();
ensurePlusAtEnd();
})();</script>
</body>
</html>
