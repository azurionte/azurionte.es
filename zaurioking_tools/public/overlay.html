
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overlay - Zaurioking Roulette</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: transparent;
      overflow: hidden;
      font-family: 'Orbitron', Arial, sans-serif;
    }
    #roulette-container {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      height: 600px;
      pointer-events: none;
    }
    #roulette-canvas {
      width: 100%;
      height: 100%;
      background: transparent;
      display: block;
    }
    #pointer {
  position: absolute;
  left: 50%;
  top: calc(50% - 290px);
  transform: translate(-50%, 0);
  width: 0;
  height: 0;
  border-left: 32px solid transparent;
  border-right: 32px solid transparent;
  border-top: 48px solid #00fff7;
  filter: drop-shadow(0 0 16px #00fff7cc);
  z-index: 2;
    }
    .status-squircles {
      position: absolute;
      left: 740px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 2.2rem;
      z-index: 3;
      min-width: 360px;
      max-width: 400px;
    }
    .squircle {
      background: rgba(160,32,240,0.7);
      border-radius: 32px;
      border: 3px solid magenta;
      box-shadow: 0 0 16px #a020f088;
      padding: 1.2rem 1.1rem;
      min-width: 220px;
      max-width: 340px;
      color: #fff;
      font-size: 1.25rem;
      text-align: center;
      font-family: 'Montserrat', Arial, sans-serif;
      word-break: break-word;
      line-height: 1.3;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .selected-challenge {
      border: 3px solid #00fff7;
      box-shadow: 0 0 24px #00fff7cc;
      animation: glow 1s infinite alternate;
    }
      #countdown-overlay-container {
        position: absolute;
        top: 32px;
        left: 32px;
        z-index: 10;
        pointer-events: none;
      }
      #countdown-overlay {
        background: rgba(160,32,240,0.7);
        border-radius: 32px;
        border: 3px solid magenta;
        box-shadow: 0 0 16px #a020f088;
        padding: 1.2rem 2.2rem;
        min-width: 220px;
        max-width: 340px;
        color: #fff;
        font-size: 2.2rem;
        text-align: center;
        font-family: 'Montserrat', Arial, sans-serif;
        letter-spacing: 0.12em;
        text-shadow: 0 0 16px #00fff7cc, 0 0 2px #000;
        user-select: none;
        line-height: 1.1;
        font-weight: 700;
        transition: background 0.3s, box-shadow 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    @keyframes glow {
      from { box-shadow: 0 0 24px #00fff7cc; }
      to { box-shadow: 0 0 48px #ff00cc; }
    }
  </style>
</head>
<body>
  <div id="countdown-overlay-container">
    <div id="countdown-overlay">00:00:00</div>
  </div>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw;">
    <div id="roulette-container" style="flex: none; position: relative;">
      <canvas id="roulette-canvas" width="600" height="600"></canvas>
      <div id="pointer"></div>
    </div>
    <div class="status-squircles" style="flex: none; margin-left: 60px; display: flex; flex-direction: column; align-items: flex-start;">
      <div class="squircle" id="selectedChallengeBox"><span style="white-space:nowrap;">Reto:&nbsp;</span><span id="selectedChallenge">-</span></div>
      <div class="squircle">Jugadas: <span id="jugadasOverlay">0</span></div>
      <div class="squircle">Ganadas: <span id="ganadasOverlay">0</span></div>
    </div>
  </div>
  <script src="https://azurionte-es-1.onrender.com/socket.io/socket.io.js"></script>
  <script>
    // Get sessionId from URL
    function getSessionId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('session') || '1234';
    }
  const sessionId = getSessionId();
  const socket = io('https://azurionte-es-1.onrender.com');
    let challenges = [];
    let selectedIdx = null;
    let jugadas = 0;
    let ganadas = 0;
    let countdown = '00:00:00';
    let wheelRotation = 0; // radians

    socket.emit('overlay-join', { sessionId });

    socket.on('session-state', state => {
      challenges = state.challenges || [];
      jugadas = state.jugadas || 0;
      ganadas = state.ganadas || 0;
      selectedIdx = state.selectedChallenge;
      countdown = state.countdown || '00:00:00';
      drawRoulette(selectedIdx, wheelRotation);
  document.getElementById('selectedChallenge').textContent = selectedIdx != null ? challenges[selectedIdx] : '-';
  document.getElementById('jugadasOverlay').textContent = jugadas;
  document.getElementById('ganadasOverlay').textContent = ganadas;
  document.getElementById('countdown-overlay').textContent = countdown;
  document.getElementById('countdown-overlay').textContent = countdown;
    });

    socket.on('spin', data => {
      if (typeof data.selected === 'number') {
        spinRoulette(data.selected);
      }
    });

    const canvas = document.getElementById('roulette-canvas');
    const ctx = canvas.getContext('2d');
    const radius = 280;
    const centerX = 300;
    const centerY = 300;

    function drawRoulette(selected, rotation) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const n = challenges.length;
      for (let i = 0; i < n; i++) {
        const angleStart = (2 * Math.PI * i) / n + rotation;
        const angleEnd = (2 * Math.PI * (i + 1)) / n + rotation;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, angleStart, angleEnd);
        ctx.closePath();
        ctx.fillStyle = i === selected ? '#a020f0' : `hsl(${(i * 360) / n}, 80%, 55%)`;
        ctx.globalAlpha = i === selected ? 0.95 : 0.7;
        ctx.shadowColor = i === selected ? '#ff00cc' : '#000';
        ctx.shadowBlur = i === selected ? 24 : 8;
        ctx.fill();
        ctx.restore();
        // Draw challenge text, split into two lines if too long
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angleStart + (angleEnd - angleStart) / 2);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = i === selected ? 'bold 1.1rem Montserrat' : '1rem Montserrat';
        ctx.fillStyle = i === selected ? '#fff' : '#222';
        ctx.shadowColor = i === selected ? '#00fff7' : '#000';
        ctx.shadowBlur = i === selected ? 12 : 2;
        let text = challenges[i] || '';
        let maxLen = 22;
        if (text.length > maxLen) {
          // Try to split at nearest space before maxLen
          let splitIdx = text.lastIndexOf(' ', maxLen);
          if (splitIdx === -1) splitIdx = maxLen;
          let line1 = text.slice(0, splitIdx);
          let line2 = text.slice(splitIdx).trim();
          ctx.fillText(line1, radius * 0.65, -12, 160);
          ctx.fillText(line2, radius * 0.65, 12, 160);
        } else {
          ctx.fillText(text, radius * 0.65, 0, 160);
        }
        ctx.restore();
      }
    }

    drawRoulette(selectedIdx, wheelRotation);

    function spinRoulette(idx) {
      const n = challenges.length;
      // Calculate final rotation so idx's wedge is centered at 12 o'clock (pointer)
      const wedgeAngle = (2 * Math.PI) / n;
      const targetAngle = (3 * Math.PI / 2) - ((2 * Math.PI * idx) / n) - wedgeAngle / 2;
      let spins = Math.floor(Math.random() * 8) + 8;
      let currentRotation = wheelRotation;
      let totalRotation = spins * 2 * Math.PI + targetAngle - (currentRotation % (2 * Math.PI));
      let steps = 50 + Math.floor(Math.random() * 30);
      let step = 0;
      function animate() {
        step++;
        // Ease out
        let progress = step / steps;
        let eased = 1 - Math.pow(1 - progress, 3);
        wheelRotation = currentRotation + totalRotation * eased;
        drawRoulette(null, wheelRotation); // Don't reveal until finished
        if (step < steps) {
          requestAnimationFrame(animate);
        } else {
          wheelRotation = currentRotation + totalRotation;
          drawRoulette(idx, wheelRotation);
          selectedIdx = idx;
          document.getElementById('selectedChallenge').textContent = challenges[selectedIdx];
          document.getElementById('selectedChallengeBox').classList.add('selected-challenge');
          setTimeout(() => {
            document.getElementById('selectedChallengeBox').classList.remove('selected-challenge');
          }, 3000);
        }
      }
      animate();
    }
  </script>
</body>
</html>
